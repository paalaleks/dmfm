# User Story 7.1: Implement Database Table and RLS for Song Likes

**ID:** STORY-007.1
**Epic:** [EPIC-007: Persist Song Likes in Local Database](../epics/epic7.md)
**Status:** Done
**Priority:** High
**Assignee:** TBD
**Reporter:** Architect Agent
**Created Date:** 2024-07-28
**Last Updated Date:** 2024-07-28
**Estimated Story Points:** 3

## Description

**As a** System,
**I want to** have a database table `song_likes` to store user song preferences, including user ID, track Spotify ID, an optional reference to the source playlist, and timestamp, along with appropriate RLS policies,
**So that** these preferences can be securely recorded, managed by the user, linked to a playlist if applicable, and potentially made available for other application features.

## Acceptance Criteria

1.  **Migration File Created:**
    *   [x] SQL migration file(s) are created/updated in the `supabase/migrations/` directory.
    *   [x] The migration file(s) are named according to the `YYYYMMDDHHmmss_short_description.sql` convention (e.g., `20240728120000_create_song_likes_table.sql` for initial creation, and a new one like `YYYYMMDDHHmmss_alter_song_likes_add_playlist_fk.sql` for modifications).
    *   [x] The migration(s) follow guidelines from `create-migration.mdc` and `postgres-sql-style-guide.mdc`.
2.  **`song_likes` Table Created/Updated:**
    *   [x] The migration(s) ensure a table named `public.song_likes` exists with the correct schema.
    *   [x] The table includes the following columns:
        *   `id`: `uuid` (Primary Key, default `gen_random_uuid()`).
        *   `user_id`: `uuid` (Not Null, Foreign Key referencing `public.profiles(id)` with `on delete cascade`).
        *   `track_spotify_id`: `text` (Not Null, stores the Spotify track ID).
        *   `playlist_id`: `uuid` (Nullable, Foreign Key referencing `public.playlists(id)` with `on delete set null`. Stores the ID of the playlist from which the song was liked, if applicable).
        *   `liked_at`: `timestamptz` (Not Null, default `now()`).
        *   `created_at`: `timestamptz` (Not Null, default `now()`).
        *   [x] A `UNIQUE` constraint (e.g., `uq_song_likes_user_track_playlist`) is added/updated on (`user_id`, `track_spotify_id`, `playlist_id`) to ensure uniqueness per user, per track, per playlist context (where NULL `playlist_id` is a distinct context).
        *   [x] A comment is added to the table explaining its purpose (e.g., 'Stores user song likes/saves, potentially linked to a source playlist.').
        *   [x] A comment is added to the `playlist_id` column (e.g., 'The playlist from which the song was liked, if applicable. References public.playlists(id).').
3.  **Indexes Created:**
    *   [x] An index is created on `user_id`.
    *   [x] An index is created on `track_spotify_id`.
    *   [x] An index is created on `playlist_id`.
    *   [x] The `UNIQUE` constraint on (`user_id`, `track_spotify_id`, `playlist_id`) will automatically create a composite index.
4.  **Row Level Security (RLS) Enabled:**
    *   [x] RLS is enabled on the `public.song_likes` table.
5.  **RLS Policies Implemented:**
    *   [x] Policies adhere to `create-rls-policies.mdc`.
    *   [x] **SELECT Policy (Authenticated Users):** Authenticated users can select their own likes.
        *   `CREATE POLICY "Users can view their own song likes." ON public.song_likes FOR SELECT TO authenticated USING ((auth.uid() = user_id));`
    *   [x] **INSERT Policy (Authenticated Users):** Authenticated users can insert new likes for themselves.
        *   `CREATE POLICY "Users can insert their own song likes." ON public.song_likes FOR INSERT TO authenticated WITH CHECK ((auth.uid() = user_id));`
    *   [x] **DELETE Policy (Authenticated Users):** Authenticated users can delete their own likes.
        *   `CREATE POLICY "Users can delete their own song likes." ON public.song_likes FOR DELETE TO authenticated USING ((auth.uid() = user_id));`
    *   [x] RLS policies for the `anon` role are not required for this table as liking songs is an authenticated action.

## Technical Notes

-   The `profiles` table (referenced by `user_id`) is assumed to exist and have an `id` column of type `uuid`.
-   The `track_spotify_id` will be a string identifier from Spotify.
-   Ensure all SQL adheres to the `postgres-sql-style-guide.mdc`.
-   RLS policies are defined for `authenticated` users. The addition of `playlist_id` (nullable) does not change the core logic of users managing their own likes.
-   The migration script should be idempotent where possible, though typical Supabase migrations are run once.
-   The original unique constraint on (`user_id`, `track_spotify_id`) must be correctly identified and dropped before adding the new unique constraint that includes `playlist_id`. The assumed name for the old constraint is `song_likes_user_id_track_spotify_id_key`.

## Definition of Done

-   [x] Migration file(s) for `song_likes` table (creation and alteration for `playlist_id`) are created.
-   [x] The final schema matches the updated acceptance criteria.
-   [x] RLS policies are defined as per the acceptance criteria.
-   [x] All relevant guidelines (`create-migration`, `create-rls-policies`, `postgres-sql-style-guide`) have been considered in the definition. 