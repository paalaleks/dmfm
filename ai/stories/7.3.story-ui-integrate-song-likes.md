# Story 7.3: Integrate Local Song Likes with Player UI

**ID:** STORY-007.3
**Epic:** [EPIC-007: Persist Song Likes in Local Database](../../epics/epic7.md)
**Status:** Draft
**Priority:** High
**Assignee:** TBD
**Reporter:** Story Generator Agent
**Created Date:** 2024-07-29
**Last Updated Date:** 2024-07-29
**Estimated Story Points:** 5

## Goal & Context

**User Story:** As a user, when I tap the heart button in the player, I want my action to both update my Spotify library and record the like in the app's own database, so that my preferences are preserved in Spotify *and* available for social features within the app.

**Context:**
* Story 7.1 created the `song_likes` table and RLS.
* Story 7.2 exposes `likeSongAction` and `unlikeSongAction` Server Actions for inserting/deleting rows in that table.
* The player UI already shows a heart icon and currently calls only Spotify helpers (`checkIfTrackIsSavedAPI`, `saveTrackAPI`, `unsaveTrackAPI`).
* This story wires the UI (and its supporting hooks/helpers) so that *both* systems are updated in parallel, without altering the existing UX.

## Detailed Requirements

1. **Dual-Write on Like:**
   * When the user presses the heart icon and the current track is *not* saved (as determined by Spotify API):
     * Continue calling `saveTrackAPI(token, trackId)` to add the track to the user's Spotify library.
     * Also call `likeSongAction({ trackSpotifyId: trackId, playlistId? })` to insert into `song_likes`.
     * These operations should run in parallel (`Promise.allSettled`) so the UI feels snappy; handle individual failures gracefully (see Error Handling).
2. **Single-Delete on Unlike:**
   * When the user presses the heart icon and the current track *is* saved (as determined by Spotify API):
     * Call `unsaveTrackAPI(token, trackId)` to remove from Spotify library.
     * **Do NOT** call `unlikeSongAction` or remove from `song_likes` at this point.
   * If the user clicks the heart again (after unliking, so the track is not saved in Spotify):
     * The logic repeats: both Spotify and `song_likes` are updated as in the first case (see Dual-Write on Like).
3. **Initial State Check:**
   * Keep using `checkIfTrackIsSavedAPI` to decide the initial heart state (continue to rely on Spotify's library as the single source for the UI indicator).
   * No extra DB read is required on mount.
4. **Playlist Context (Optional Input):**
   * If `music-context` currently tracks the playlist the user is listening to (`currentPlaylist?.id`), pass this as `playlistId` when calling `likeSongAction` / `unlikeSongAction`.
5. **Error Handling & Resilience:**
   * If either the Spotify call or the Supabase call fails, show a toast error but do *not* revert the other operation (best-effort, eventual consistency is acceptable).
   * Log details via `console.error` with sufficient context.
6. **Type Safety & Validation:**
   * Update or create types in `types/music-context.ts` or `types/actions.ts` as needed.
7. **No Visual Regression:**
   * The heart icon logic (`isCurrentTrackSaved`) must continue to reflect Spotify's state so existing UX does not change.

## Acceptance Criteria (ACs)

AC1 – *Like:* Clicking the heart on an un-saved track triggers both `saveTrackAPI` **and** `likeSongAction`.

AC2 – *Unlike:* Clicking the filled heart on a saved track triggers only `unsaveTrackAPI`. No call is made to `unlikeSongAction` and the local `song_likes` record is retained.

AC3 – *UI state:* The heart icon still reflects Spotify's `checkIfTrackIsSavedAPI` result; no extra flicker is introduced.

AC4 – *Error Isolation:* If one operation fails but the other succeeds, a toast message is shown, errors are logged, and the successful operation is not rolled back.

AC5 – *Playlist context:* When playing a song that originated from a playlist, the `playlist_id` column is populated correctly in `song_likes`.

AC6 – *Coding standards:* All code follows `ai/docs/coding-standards.md` and resides in correct paths (`music-context/`, `app/_actions/`).

## Technical Implementation Context

- **Files to Modify**
  - `music-context/music-context.tsx` (logic for `saveCurrentTrack` / `unsaveCurrentTrack`).
  - `music-context/playlist-actions.ts` if it proxies these operations.
  - `components/player/player.tsx` (only if prop drilling or import paths change).
- **Files to Create**
  - None expected.
- **Key Technologies**: React Context, Next.js Server Actions, Supabase client, Spotify Web API helpers.
- **Environment Variables**: No new env vars.
- **Coding Notes**: Use structured return types from Server Actions; prefer `Promise.allSettled` for dual-calls.

## Tasks / Sub-tasks

- [ ] **Refactor MusicContext:**
  - [ ] Import `likeSongAction`, `unlikeSongAction` via dynamic import or direct path.
  - [ ] Update `saveCurrentTrack` to call `saveTrackAPI` + `likeSongAction`.
  - [ ] Update `unsaveCurrentTrack` to call `unsaveTrackAPI` + `unlikeSongAction`.
  - [ ] Pass `playlistId` when available.
- [ ] **Error Handling:**
  - [ ] Wrap dual-calls in `Promise.allSettled` and surface partial failures via toast.
- [ ] **UI Verification:**
  - [ ] Ensure heart indicator logic still relies on `checkIfTrackIsSavedAPI`.
  - [ ] Manual test liking/unliking across various playlists & single-track playback.
- [ ] **Docs & Types:**
  - [ ] Update type definitions if necessary.
  - [ ] Add inline code comments for new logic.

## Testing Requirements

Manual testing is sufficient:
* Like & unlike tracks from the player while monitoring Supabase table and Spotify library.
* Test with and without playlist context.
* Simulate network failure on either call and verify partial-failure behaviour.

## Story Wrap-Up (to be filled after implementation)
- **Agent Model Used:** <>
- **Completion Notes:**
- **Change Log:**
  - Initial Draft 