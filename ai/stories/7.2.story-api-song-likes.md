# Story 7.2: Implement API Endpoints (Server Actions) for Song Likes

**ID:** STORY-007.2
**Epic:** [EPIC-007: Persist Song Likes in Local Database](../../epics/epic7.md)
**Status:** Ready
**Priority:** High
**Assignee:** TBD
**Reporter:** Story Generator Agent
**Created Date:** 2024-07-29
**Last Updated Date:** 2024-07-29
**Estimated Story Points:** 3

## Goal & Context

**User Story:** As a user, I want to be able to "like" and "unlike" songs within the application, so that my preferences are saved in the application's database and can be used for future features.

**Context:** This story builds upon Story 7.1 ([Implement Database Table and RLS for Song Likes](../7.1.story-save-likes.md)), which created the `song_likes` database table and its Row Level Security (RLS) policies. This story focuses on implementing the backend logic using Next.js Server Actions to allow clients to interact with this table by adding and removing song likes.

## Detailed Requirements

(Derived from Epic 7: "API Endpoints/Server Actions")
*   Implement Server Actions to record a song like from the client to the `song_likes` table.
*   Implement Server Actions to remove a song like from the `song_likes` table.
*   These actions must respect the RLS policies established in Story 7.1, ensuring users can only manage their own likes.
*   Inputs for creating a like should include `track_spotify_id` and an optional `playlist_id`. The `user_id` will be derived from the authenticated session.
*   Inputs for removing a like should allow identifying the specific like to remove (e.g., by `track_spotify_id` and optional `playlist_id` for the authenticated user).

## Acceptance Criteria (ACs)

1.  **`likeSongAction` Server Action Created:**
    *   [ ] A Next.js Server Action, named `likeSongAction`, is implemented.
    *   [ ] It accepts an object containing `trackSpotifyId` (string, non-empty) and `playlistId` (string, optional, can be null or undefined) as input.
    *   [ ] The action successfully inserts a new record into the `public.song_likes` table for the currently authenticated user.
    *   [ ] `user_id` is derived from the authenticated session via Supabase server client.
    *   [ ] It returns a structured response: `{ success: true, data: { id: string, liked_at: string, ... } }` on success, containing the newly created `song_like` record (or at least its `id` and `liked_at` timestamp).
    *   [ ] It handles potential errors gracefully (e.g., violation of the `uq_song_likes_user_track_playlist` unique constraint, database errors, unauthenticated user), returning `{ success: false, error: "Error message" }`.
    *   [ ] Adherence to RLS policies is inherently tested as Supabase will enforce them.
2.  **`unlikeSongAction` Server Action Created:**
    *   [ ] A Next.js Server Action, named `unlikeSongAction`, is implemented.
    *   [ ] It accepts an object containing `trackSpotifyId` (string, non-empty) and `playlistId` (string, optional, can be null or undefined) as input to identify the like to be removed.
    *   [ ] The action successfully deletes the corresponding record from the `public.song_likes` table for the currently authenticated user.
    *   [ ] It returns a structured response: `{ success: true }` on successful deletion.
    *   [ ] It handles cases where the like to be removed doesn't exist for the user gracefully (e.g., returns `{ success: true }` or `{ success: false, error: "Like not found" }` - to be decided, but should not be a critical error).
    *   [ ] It handles other potential errors (e.g., database errors, unauthenticated user) gracefully, returning `{ success: false, error: "Error message" }`.
    *   [ ] Adherence to RLS policies is inherently tested.
3.  **Input Validation:**
    *   [ ] Both Server Actions validate their inputs using Zod (as per `ai/docs/tech-stack.md`). For example, `trackSpotifyId` must be a non-empty string.
4.  **Authentication Enforcement:**
    *   [ ] Both Server Actions verify that a user is authenticated before proceeding. If not, they return an appropriate error (e.g., `{ success: false, error: "Authentication required" }`).
5.  **Coding Standards & Project Structure:**
    *   [ ] All new TypeScript code adheres to `ai/docs/coding-standards.md` (e.g., naming conventions for functions: `camelCase`, files: `kebab-case.ts`).
    *   [ ] The Server Actions are placed in a new file: `app/_actions/song-likes.ts` as per `ai/docs/project-structure.md`.
    *   [ ] Uses Supabase client from `lib/supabase/server.ts` for database interactions.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `ai/docs/coding-standards.md` and understand the project structure in `ai/docs/project-structure.md`.

-   **Relevant Files:**
    -   Files to Create:
        -   `app/_actions/song-likes.ts` (for the Server Actions)
        -   Potentially a new Zod schema definition file in `types/actions.ts` or within `app/_actions/song-likes.ts` if specific to these actions.
    -   Files to Modify: None explicitly, but developer may need to update `types/database.ts` if not already up-to-date (though Story 7.1 should have covered the `song_likes` table).
-   **Key Technologies:**
    -   Next.js (Server Actions)
    -   Supabase (PostgreSQL database interactions via Supabase client)
    -   TypeScript
    -   Zod (for input validation)
-   **API Interactions / SDK Usage:**
    -   Supabase JavaScript Client (`@supabase/supabase-js` via `lib/supabase/server.ts`)
        -   `insert()` into `song_likes` table.
        -   `delete()` from `song_likes` table with appropriate filters (`user_id`, `track_spotify_id`, `playlist_id`).
-   **Data Structures:**
    -   Input types for Server Actions (to be defined with Zod).
    -   Return types for Server Actions (e.g., `Promise<{ success: boolean; data?: any; error?: string }>`).
    -   `song_likes` table structure as defined in Story 7.1 (columns: `id`, `user_id`, `track_spotify_id`, `playlist_id`, `liked_at`, `created_at`).
-   **Environment Variables:**
    -   Standard Supabase environment variables (`NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY` if needed for server client, but typically not for user-context actions). Assumed to be configured.
-   **Coding Standards Notes:**
    -   Follow error handling patterns from `ai/docs/coding-standards.md` for Server Actions (structured success/error responses).
    -   Server Action functions should be `async`.
    -   Ensure Supabase client is correctly instantiated for server-side use.
    -   The `project_ref` for Supabase is `jaoksbhfyfyqubkmjvso`.

## Tasks / Subtasks

-   [ ] **Setup:**
    -   [ ] Create `app/_actions/song-likes.ts`.
    -   [ ] Define Zod schemas for `likeSongAction` and `unlikeSongAction` inputs.
-   [ ] **Implement `likeSongAction`:**
    -   [ ] Add function signature and input validation using Zod.
    -   [ ] Implement authentication check.
    -   [ ] Implement logic to insert a record into `song_likes` table using Supabase client.
        -   Ensure `user_id` is from the authenticated session.
        -   Handle `playlist_id` being potentially null.
    -   [ ] Implement success and error response handling.
-   [ ] **Implement `unlikeSongAction`:**
    -   [ ] Add function signature and input validation using Zod.
    -   [ ] Implement authentication check.
    -   [ ] Implement logic to delete a record from `song_likes` table using Supabase client, based on `user_id`, `track_spotify_id`, and `playlist_id`.
    -   [ ] Implement success and error response handling (including "like not found").
-   [ ] **Testing & Verification:**
    -   [ ] Manually test `likeSongAction` (e.g., via a temporary client-side call or tool) with and without `playlistId`. Verify record creation in DB and RLS.
    -   [ ] Manually test `unlikeSongAction` for existing and non-existing likes. Verify record deletion.
    -   [ ] Test error conditions (unauthenticated, duplicate like).

## Testing Requirements

**Guidance:** Verify implementation against the ACs. Follow general testing approach in `ai/docs/testing-strategy.md`.

-   **Unit Tests:** (Optional, based on `testing-strategy.md`; focus on manual/integration for Server Actions initially if simpler)
    -   Consider mocking Supabase client calls if unit tests are written for the core logic within actions.
-   **Integration Tests:** Not explicitly required for this story if manual verification is thorough.
-   **Manual/CLI Verification:**
    -   Use a temporary client-side component or a tool like Postman (if Server Actions were exposed as HTTP endpoints, which they are not directly) or browser developer console to invoke the Server Actions.
    -   Verify database state changes in the Supabase dashboard (`song_likes` table).
    -   Verify RLS by ensuring actions only affect the logged-in user's data.
    -   Test with various inputs:
        -   Liking a song without `playlist_id`.
        -   Liking a song with `playlist_id`.
        -   Liking a song that's already liked (expect unique constraint error, handled gracefully).
        -   Unliking a song.
        -   Attempting to unlike a song not liked by the user.
        -   Attempting actions without being authenticated.

## Story Wrap Up (Agent Populates After Execution)

-   **Agent Model Used:** `<Agent Model Name/Version>`
-   **Completion Notes:**
-   **Change Log:**
    -   Initial Draft 