# Story 2.3: Implement Playlist Submission/Import

**Status:** DONE

## Goal & Context

**User Story:** As a system/user, I want to submit/import Spotify playlist IDs, fetch their metadata and track details from Spotify, and store this information, so that these playlists can be used for taste profiling and be discoverable by other users.

**Context:** This story builds upon the defined database schema (Story 2.1) and is related to fetching user-specific Spotify data (Story 2.2). It focuses on ingesting playlist data, which is crucial for the core functionality of allowing users to discover and play playlists from others with similar tastes (FR21, FR22). This will populate the `playlists` and `playlist_items` tables.

## Detailed Requirements

*   Goal: Allow users (or the system) to submit/import Spotify playlist IDs, fetch playlist metadata and track details from Spotify, and store them in the `playlists` and `playlist_items` tables.

## Acceptance Criteria (ACs)

- AC1: A mechanism (e.g., a server action, an API endpoint) exists to accept a Spotify playlist ID.
- AC2: Given a valid Spotify playlist ID, the system successfully fetches playlist metadata (name, description, owner, images, etc.) from the Spotify API.
- AC3: Given a valid Spotify playlist ID, the system successfully fetches all tracks (track ID, name, artists, duration, etc.) within that playlist from the Spotify API.
- AC4: Fetched playlist metadata is correctly stored in the `playlists` table, linked to the submitting user if applicable.
- AC5: Fetched track details are correctly stored in the `playlist_items` table, associated with the correct playlist.
- AC6: The system handles potential errors gracefully (e.g., invalid playlist ID, API rate limits, network issues).
- AC7: Consider how to handle duplicate playlist submissions (e.g., if the same playlist ID is submitted again).

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Refer to the linked `docs/` files for broader context if needed.

- **Relevant Files:**
  - Files to Create:
    - `app/actions/spotify/import-playlist.ts` (or similar, for the server action/handler)
    - `lib/spotify-api.ts` (if not already existing, for Spotify API interactions, or augment existing)
    - Potentially new files for database interaction if not covered by existing helpers (e.g., `lib/db/playlists.ts`)
  - Files to Modify:
    - Relevant UI components if a user-facing submission form is part of this story (TBD based on design).
    - `docs/data-models.md` (to ensure `playlists` and `playlist_items` schemas are accurately reflected/updated if needed).
  - _(Hint: See `docs/project-structure.md` for overall layout)_

- **Key Technologies:**
  - Next.js (Server Actions)
  - TypeScript
  - Supabase (for database interactions)
  - Spotify Web API
  - _(Hint: See `docs/tech-stack.md` for full list)_

- **API Interactions / SDK Usage:**
  - Spotify Web API:
    - Endpoint for fetching playlist details (e.g., `GET /v1/playlists/{playlist_id}`)
    - Endpoint for fetching playlist items/tracks (e.g., `GET /v1/playlists/{playlist_id}/tracks`)
    - Handle authentication (OAuth 2.0 Client Credentials Flow or Authorization Code Flow if user-specific permissions are needed beyond general playlist access).
  - Supabase SDK:
    - `supabase.from('playlists').insert(...)`
    - `supabase.from('playlist_items').insert(...)`
    - Queries to check for existing playlists if handling duplicates.
  - _(Hint: See `docs/api-reference.md` for details on external APIs and SDKs)_

- **UI/UX Notes:**
  - If a user-facing form is implemented, it should clearly indicate the expected input (Spotify Playlist ID or URL) and provide feedback on submission status (success, error).
  - For now, the primary focus is the backend logic; a simple internal trigger or a basic form might suffice.

- **Data Structures:**
  - `playlists` table (as defined in `docs/data-models.md` or Story 2.1, ensure columns for Spotify ID, name, description, owner_spotify_id, images_json, etc.)
  - `playlist_items` table (as defined in `docs/data-models.md` or Story 2.1, ensure columns for playlist_id (FK), track_spotify_id, track_name, artists_json, duration_ms, etc.)
  - Types/Interfaces in TypeScript for Spotify API responses and database-bound objects.
  - _(Hint: See `docs/data-models.md` for key project data structures)_

- **Environment Variables:**
  - `SPOTIFY_CLIENT_ID`
  - `SPOTIFY_CLIENT_SECRET`
  - (Potentially others related to Spotify API access or app configuration)
  - _(Hint: See `docs/environment-vars.md` for all variables)_

- **Coding Standards Notes:**
  - Use `async/await` for all API calls and database operations.
  - Implement robust error handling and logging.
  - Ensure Spotify API calls handle pagination if playlists can contain more tracks than a single API call returns.
  - Adhere to project-defined naming conventions and code style.
  - _(Hint: See `docs/coding-standards.md` for full standards)_

## Tasks / Subtasks

- [x] **Task 1:** Design and implement the function/server action signature for `importPlaylist(playlistId: string)`.
- [x] **Task 2:** Implement Spotify API authentication (e.g., Client Credentials flow to get an access token).
- [x] **Task 3:** Implement logic to fetch playlist metadata from Spotify API using the provided `playlistId`.
  - [ ] Map API response fields to `playlists` table columns.
- [x] **Task 4:** Implement logic to fetch playlist tracks from Spotify API.
  - [x] Handle pagination for playlists with many tracks.
  - [x] Map API response fields to `playlist_items` table columns.
- [x] **Task 5:** Implement database logic to store fetched playlist metadata into the `playlists` table.
  - [x] Include logic to handle/check for duplicate playlist submissions (e.g., based on Spotify ID).
- [x] **Task 6:** Implement database logic to store fetched track details into the `playlist_items` table, linking them to the parent playlist.
- [x] **Task 7:** Implement comprehensive error handling for API calls, database operations, and invalid inputs.
- [x] **Task 8:** (Optional - depends on immediate need) Create a basic UI or an internal script/test to trigger the import process.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

- **Unit Tests:**
  - Test the `importPlaylist` server action/handler.
  - Mock Spotify API calls to simulate successful responses, error responses (e.g., 404 for invalid ID, 429 for rate limiting), and paginated responses.
  - Mock Supabase client calls to verify correct data insertion and querying.
  - Test utility functions for mapping API data to database schema.
  - Test error handling paths.
- **Integration Tests:**
  - (If feasible and time permits) Test the actual interaction with a live (test) Spotify API and Supabase instance with a known public playlist.
  - This might be deferred to E2E testing if unit tests provide sufficient confidence for this isolated module.
- **Manual/CLI Verification:**
  - Manually trigger the import mechanism with a few known Spotify playlist IDs (public playlists).
  - Verify that the data appears correctly in the `playlists` and `playlist_items` tables in Supabase.
  - Test with a playlist ID that is known to be invalid to ensure error handling works.
  - Test with a very long playlist to check pagination logic.
- _(Hint: See `docs/testing-strategy.md` for the overall approach)_

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:**
  - Initial Draft 