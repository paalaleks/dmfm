# Story 2.5: Display and Manage User-Submitted Playlists

**Epic:** [Epic 2: Playlist Management and Taste Profiling](../epics/epic2.md)
**Goal:** Provide users with an interface to view their imported playlists and allow them to delete playlists they no longer want in the system. This includes handling all necessary database cleanup via cascading deletes.
**Status:** Approved

## Acceptance Criteria

1.  **AC1:** Authenticated users can view a list of playlists they have personally submitted/imported on their profile page (`app/(protected)/profile/playlists/page.tsx`).
2.  **AC2:** Each listed playlist displays key information such as its name, cover image, and total number of tracks.
3.  **AC3:** A "Delete" button or icon is present for each playlist in the list.
4.  **AC4:** Clicking the "Delete" button prompts the user with a confirmation dialog before proceeding with the deletion.
5.  **AC5:** Upon user confirmation, the selected playlist is deleted from the `public.playlists` table in the Supabase database.
6.  **AC6:** Deleting a playlist from `public.playlists` correctly triggers cascading deletes for related records in `public.playlist_tracks` (aliased as `playlist_items` in documentation) and `public.user_playlist_matches` (or `user_playlist_interactions` as per `data-models.md`), and `public.playlist_track_artist_aggregates` due to foreign key constraints with `ON DELETE CASCADE`.
7.  **AC7:** After a successful deletion, the UI updates in real-time (or upon a refresh) to remove the playlist from the displayed list.
8.  **AC8:** If the deletion process fails (e.g., network error, database error), an appropriate error message is displayed to the user.
9.  **AC9:** The interface for displaying and managing playlists is responsive and user-friendly.
10. **AC10:** Only playlists where the `submitted_by_user_id` matches the currently authenticated user's ID are displayed and can be deleted by them.

## Tasks

1.  **Task 2.5.1 (Frontend): Design and Implement Playlist Display** - Completed
    *   Develop the UI in `app/(protected)/profile/playlists/page.tsx` to fetch and list playlists associated with the authenticated user. - Completed
    *   Each item should display playlist name, cover image, and track count. - Completed
    *   Handle loading states and empty states (e.g., when a user has no imported playlists). - Completed
2.  **Task 2.5.2 (Frontend): Implement Delete Button and Confirmation** - Completed
    *   Add a "Delete" button/icon to each playlist item. - Completed
    *   Implement a confirmation modal/dialog that appears when the delete button is clicked, asking the user to confirm the action. - Completed
3.  **Task 2.5.3 (Backend): Create Delete Playlist Logic** - Completed
    *   Implement a Supabase Server Action or Edge Function (e.g., `deleteUserPlaylist`) that accepts a `playlist_id`. - Completed
    *   This function must verify that the `playlist_id` belongs to a playlist submitted by the authenticated user (`submitted_by_user_id` matches `auth.uid()`). - Completed
    *   The function will execute the SQL `DELETE` command on the `public.playlists` table for the given `playlist_id`. - Completed
4.  **Task 2.5.4 (Frontend): Integrate Deletion Logic** - Completed
    *   Call the backend delete function from the frontend when the user confirms deletion. - Completed
    *   Handle the response: on success, update the UI to remove the playlist; on error, display an error message. - Completed
5.  **Task 2.5.5 (Data Model Verification): Confirm Cascade Behavior** - Partially Completed (Action Required)
    *   Verify that `ON DELETE CASCADE` is correctly implemented for all relevant foreign keys pointing to `playlists.id` as detailed in `docs/data-models.md` (specifically for `playlist_tracks.playlist_id`, `user_playlist_interactions.playlist_id`, and `playlist_track_artist_aggregates.playlist_id`).
        *   `playlist_tracks.playlist_id`: **CONFIRMED** as documented with `ON DELETE CASCADE`.
        *   `user_playlist_interactions.playlist_id`: **CONFIRMED** as documented with `ON DELETE CASCADE`.
        *   `playlist_track_artist_aggregates.playlist_id`: **ACTION REQUIRED**. This table exists in the DB but was not in `data-models.md`. Its `ON DELETE CASCADE` status is *assumed* for AC6 but **MUST BE VERIFIED in the database schema**. A migration may be needed if not set.
    *   Update `data-models.md` if `playlist_track_artist_aggregates` cascade behavior needs to be explicitly documented. - **ATTEMPTED - BLOCKED**. Automated addition of `playlist_track_artist_aggregates` to `docs/data-models.md` failed. **MANUAL UPDATE REQUIRED** for this documentation (details provided in chat).
6.  **Task 2.5.6 (Testing): End-to-End Testing**
    *   Thoroughly test the playlist display functionality.
    *   Test the delete functionality, including the confirmation step and UI updates.
    *   Verify in the database that the playlist and all its associated data (tracks, interactions, aggregations) are correctly removed after deletion.
    *   Test error handling for failed deletions.
7.  **Task 2.5.7 (Styling): UI/UX Refinements**
    *   Ensure the playlist management section is visually consistent with the rest of the application and provides a good user experience. 