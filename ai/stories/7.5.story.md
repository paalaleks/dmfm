# Story 7.5: Comprehensive Testing of Spotify SDK Resilience

**Status:** Approved

## Goal & Context

**User Story:** As a QA/developer, I want to thoroughly test the Spotify SDK's resilience mechanisms across various scenarios (wake-from-sleep, token expiry, auth errors, network changes), so that we can confirm the system behaves as expected and provides a stable user experience.

**Context:** This story is the culmination of Epic 7, validating that all the implemented improvements (Stories 7.1-7.4) work together effectively. It's focused on end-to-end testing of the resilience features.

## Detailed Requirements

Perform comprehensive testing to validate that the Spotify SDK integration can gracefully handle and recover from common issues like system sleep, token expiry, authentication errors, and network disruptions. Ensure player state is accurately reported.

## Acceptance Criteria (ACs)

- AC1: **Wake-from-Sleep Recovery:** The application successfully recovers Spotify player functionality (becomes ready, can play music) after the host computer wakes from sleep (duration > 1 hour). This recovery process should include proactively checking token validity and performing a refresh if necessary, alongside re-establishing any required connections.
- AC2: **Token Expiry & Refresh:** The system intelligently handles Spotify access tokens. It first checks if a stored token is still valid (and not within a short buffer period of expiry). If valid, the existing token is used. If the token is expired or nearing expiry, it is automatically refreshed (as per Story 7.1), allowing playback to continue or resume without manual user intervention.
- AC3: **`authentication_error` Recovery:** Simulated or induced `authentication_error` events trigger the defined recovery flow (Story 7.2), and the player successfully becomes operational again.
- AC4: **(If Implemented) Network Disruption Recovery:** Disconnecting and then reconnecting the network triggers appropriate player connection checks (Story 7.3), and the player attempts to recover.
- AC5: **Accurate State Reporting:** Throughout all test scenarios, the player's reported state in the application (e.g., `isReady`, `isActive`, `currentTrack`, `error`) accurately reflects the true status of the Spotify Web Playback SDK.
- AC6: No JavaScript errors related to the Spotify SDK integration are consistently observed in the browser console during these test scenarios after recovery mechanisms have run.

## Technical Implementation Context

**Guidance:** This story involves manual end-to-end testing. The developer/QA executing this story will need to simulate various conditions.

- **Key Technologies:**
  - Browser Developer Tools (for console logs, network inspection, and potentially manipulating application state for testing).

- **API Interactions / SDK Usage:**
  - Focus is on observing the behavior of the integrated Spotify SDK.
  - The backend logic for Spotify token refreshing, including the pre-check for existing valid tokens (see AC2), is primarily handled by the `app/api/spotify/refresh-token/route.ts` endpoint.

- **Environment Variables:** Standard development/testing environment.

- **Coding Standards Notes:**
  - Refer to `docs/testing-strategy.md` for general testing approaches. Test cases should be documented if this were a formal QA process.

## Tasks / Subtasks

- [x] **Test Case Execution: Wake-from-Sleep**
  - [x] Authenticate with Spotify, ensure player is working.
  - [x] Put the computer to sleep for at least 1 hour.
  - [x] Wake the computer, open the application.
  - [x] Observe: Does the player recover? Can you play music? Specifically note any indications of a token refresh attempt or success (e.g., via console logs or network activity) as part of the wake-up recovery. Check general console for other errors/recovery logs. Verify AC1.
- [ ] **Test Case Execution: Token Expiry & Refresh (Simulated if necessary)**
  - [ ] If difficult to naturally wait for token expiry, attempt to simulate (e.g., by temporarily shortening token lifetime in a mock server if used for token fetching in dev, or by using developer tools to clear only the access token if refresh token is in an httpOnly cookie, then try an action requiring a token).
  - [ ] Observe: Does the `getOAuthToken` flow trigger a refresh (Story 7.1)? Does playback continue/resume? Verify AC2.
- [ ] **Test Case Execution: `authentication_error` Recovery**
  - [ ] Attempt to induce an `authentication_error` (e.g., temporarily revoke app permissions in Spotify dashboard then try to use player, or manipulate token to be invalid before `getOAuthToken` if possible).
  - [ ] Observe: Does the handler from Story 7.2 trigger? Does it attempt to disconnect and reconnect? Does player become operational? Verify AC3.
- [ ] **Test Case Execution: (Optional) Network Disruption**
  - [ ] If network listeners from Story 7.3 were implemented:
    - [ ] With player connected, disconnect network. Observe player state.
    - [ ] Reconnect network. Observe if player attempts to recover. Verify AC4.
- [ ] **General Observation for all tests:**
  - [ ] Monitor the player's reported state in the application (`isReady`, `isActive`, `currentTrack`, `error`) to ensure it accurately reflects reality. Verify AC5.
  - [ ] Monitor browser console for errors. Verify AC6.
- [ ] **Documentation of Test Results:**
  - [ ] Briefly note down pass/fail for each AC and any significant observations or bugs found.

## Testing Requirements

**Guidance:** This entire story *is* the testing requirement for the epic. Manual, scenario-based testing is key.

- **Manual Verification:** Perform all tasks listed above.
- **Key Scenarios to Cover:**
    - System sleep and wake.
    - Token expiry (natural or simulated).
    - Forced `authentication_error`.
    - Network disconnect/reconnect (if applicable).

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** 
  - **Test Case: Wake-from-Sleep (AC1, AC5, AC6)**
    - **AC1 (Wake-from-Sleep Recovery):** PASS. After waking from >1 hour sleep, the player functionally recovers. Music can be played and controlled (skip tracks). This implies a successful token refresh or validation occurred, despite noisy console logs.
      - Console logs show numerous `net::ERR_NETWORK_IO_SUSPENDED` errors upon waking, followed by Spotify SDK errors like `404` for `item_before_load` events, a `401` for `play_progress`, `CloudPlaybackClientError: PlayLoad event failed`, and `CloudPlaybackClientError: Cannot send report item_before_load when the device is not registered`.
      - API calls from `music-context.tsx` (e.g., to fetch track info, check if track is saved) also initially fail with `TypeError: Failed to fetch`, but functionality is ultimately restored.
        - Specifically, `checkIfTrackIsSavedAPI` (called from `music-context.tsx` effects) and `checkIfPlaylistIsFollowedAPI` (also called from `music-context.tsx` effects) are observed to fail with `TypeError: Failed to fetch` after waking from sleep, even when playback itself has recovered. This is due to the underlying Spotify API calls (e.g., `/me/tracks/contains`, `/playlists/.../followers/contains`) returning `401 (Unauthorized)` errors, indicating the access token used by these functions is stale/invalid post-sleep. However, these save/follow functionalities do eventually start working correctly after this initial period of errors, suggesting the token is eventually refreshed for these operations as well.
    - **AC5 (Accurate State Reporting):** PASS. `isReady` context state is `true`. The UI allows playback and track control, accurately reflecting the restored functional state of the player, despite underlying console errors.
    - **AC6 (No JS errors after recovery):** FAILED - Multiple JS errors observed in the console *during* the recovery phase after waking from sleep (network errors, Spotify SDK 40x errors, and 401s leading to TypeErrors for metadata API calls). While core playback and metadata functionalities eventually recover and work correctly, the recovery process itself is not clean and generates console errors.
        - Notably, `TypeError: Failed to fetch` occurs in `checkIfTrackIsSavedAPI` and `checkIfPlaylistIsFollowedAPI` within `music-context.tsx` after waking from sleep, driven by `401 (Unauthorized)` responses from the Spotify API for these calls. These errors are transient as the features later become functional.
- **Change Log:**
  - Initial Draft 