# Story 3.1: Setup Spotify Web Playback SDK and Music Context

**Status:** Done

## Goal & Context

**User Story:** As a developer, I want to initialize the Spotify Web Playback SDK when a user is authenticated and create a global React context to manage the player state, so that player controls and state information can be accessed throughout the application.

**Context:** This is the foundational story for Epic 3: Spotify Player and Music Interaction. It sets up the necessary client-side infrastructure (Spotify Web Playback SDK instance and state management via React Context) required for implementing player UI features (FR7), controls (FR8, FR10, FR11), and interactions (FR12, FR13) in subsequent stories. It leverages the existing Spotify authentication (Epic 1) and the SDK script loaded in `app/layout.tsx`. Crucially, the completion of Story 2.3 (Implement Playlist Submission/Import) means playlist data should now be available in the database, providing content to test against.

## Detailed Requirements

*   Create a React Context (`MusicContext`) to manage Spotify player state and provide player control functions.
*   Implement logic within the context provider to initialize the `Spotify.Player` instance after user authentication.
*   Use the authenticated user's Spotify access token (retrieved from the Supabase session) for SDK initialization.
*   Handle core SDK lifecycle events: `ready`, `not_ready`, `player_state_changed`, `authexpired`, `error`.
*   Store essential player state within the context (e.g., SDK instance, device ID, readiness status, current playback state).
*   Wrap the application's main layout (`app/layout.tsx`) with the `MusicContext.Provider`.

## Acceptance Criteria (ACs)

- AC1: A `MusicContext.tsx` file is created in the `context/` directory defining the context, state, and provider.
- AC2: The `MusicContext.Provider` wraps the main application content within `app/layout.tsx`.
- AC3: The `Spotify.Player` instance is successfully created within the `MusicContext` provider when an authenticated user session with a valid Spotify provider token is available.
- AC4: The SDK `ready` event is successfully handled, and the received `device_id` is stored in the context state.
- AC5: The SDK `player_state_changed` event is successfully handled, and the received `Spotify.PlaybackState` is stored or processed within the context state.
- AC6: SDK errors (e.g., initialization errors, authentication errors) are caught and logged, updating the context state appropriately (e.g., setting an error flag/message).
- AC7: The context provides a way to access the initialized player instance and its state (e.g., via `useContext(MusicContext)`).

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Refer to the linked `docs/` files for broader context if needed.

- **Relevant Files:**
  - Files to Create: `context/MusicContext.tsx`
  - Files to Modify: `app/layout.tsx`
  - _(Hint: See `docs/project-structure.md` for overall layout)_

- **Key Technologies:**
  - React (Context API, Hooks: `useState`, `useEffect`, `useCallback`, `useContext`, `useRef`)
  *   Next.js (App Router, Client Components)
  - TypeScript
  - Spotify Web Playback SDK (`window.Spotify`, using types from `@types/spotify-web-playback-sdk`)
  - Supabase Client (`@supabase/ssr` or `@supabase/auth-helpers-nextjs` for client-side session/token access)
  - _(Hint: See `docs/tech-stack.md` for full list)_

- **API Interactions / SDK Usage:**
  - **Spotify Web Playback SDK:**
    - `new Spotify.Player({ name: 'Playlist Chat Rooms Player', getOAuthToken: callback })`
    - `player.connect()`
    - `player.disconnect()`
    - Event listeners: `player.addListener('ready', ...)` , `player.addListener('not_ready', ...)` , `player.addListener('player_state_changed', ...)` , `player.addListener('initialization_error', ...)` , `player.addListener('authentication_error', ...)` , `player.addListener('account_error', ...)` , `player.addListener('playback_error', ...)`
    *   `getOAuthToken` callback: Must provide a function that returns a promise resolving to the current Spotify OAuth access token (obtained from the Supabase session).
  - **Supabase Client:**
    - Use client-side Supabase client (`lib/supabase/client.ts`) to get the current session and access the `provider_token` (Spotify access token). `getSession()` will be needed. Note that tokens might expire, so the `getOAuthToken` callback needs to fetch the *current* valid token from the session, relying on Supabase helpers to handle refresh implicitly if necessary.
  - _(Hint: See `docs/api-reference.md` for external APIs and SDKs)_

- **UI/UX Notes:**
  - This story focuses on the background setup. No UI elements are created here, but the context will enable future UI components.

- **Data Structures:**
  - Define interfaces for the `MusicContext` state (e.g., `MusicContextState`) including `player: Spotify.Player | null`, `deviceId: string | null`, `isReady: boolean`, `playbackState: Spotify.PlaybackState | null`, `error: string | null`).
  - _(Hint: See `docs/data-models.md` for key project data structures if relevant - not directly applicable here)_

- **Environment Variables:**
  - None directly needed by this context beyond what's used for Supabase client initialization (`NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`).

- **Coding Standards Notes:**
  - Use `useEffect` for managing SDK instance lifecycle and event listeners. Ensure cleanup functions are implemented to remove listeners and disconnect the player when the component unmounts or the user logs out.
  - Handle asynchronous operations (`getOAuthToken`, event handlers) correctly using `async/await`.
  - Define clear types for context state and props.
  - Implement robust error handling for SDK initialization and events.
  - _(Hint: See `docs/coding-standards.md` for full standards)_

## Tasks / Subtasks

- [x] **Task 1:** Define `MusicContext` interface and initial state structure in `context/MusicContext.tsx`.
- [x] **Task 2:** Create the `MusicProvider` component, including the context provider boilerplate.
- [x] **Task 3:** Implement client-side logic within `MusicProvider` to fetch the Supabase session and Spotify provider token.
    - [x] Handle cases where the user is not logged in or the session/token is unavailable.
- [x] **Task 4:** Implement the `getOAuthToken` callback function required by the Spotify SDK constructor.
- [x] **Task 5:** Implement `useEffect` hook in `MusicProvider` to initialize `Spotify.Player` when a token is available.
    - [x] Store the player instance in state or a ref.
    - [x] Call `player.connect()`.
    - [x] Implement cleanup logic (`player.disconnect()`).
- [x] **Task 6:** Add event listeners (`ready`, `not_ready`, `player_state_changed`, various error types) to the player instance.
    - [x] Update context state (`deviceId`, `isReady`, `playbackState`, `error`) based on received events.
    - [x] Log relevant information and errors.
- [x] **Task 7:** Wrap the main application layout (`app/layout.tsx`) with `<MusicProvider>`.
- [x] **Task 8:** Create and export a custom hook `useMusic()` for easy consumption of the context.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

- **Unit Tests:** (Future) Consider unit tests for the `getOAuthToken` logic or any complex state update logic within the context reducer, mocking Supabase client and Spotify SDK types.
- **Integration Tests:** (Future) Could test the context provider rendering and basic state updates with mocked SDK events.
- **Manual/CLI Verification:**
    - Log into the application with Spotify.
    - Check browser console logs for:
        - Successful Spotify Web Playback SDK initialization messages.
        - "Ready" event log with a device ID.
        *   Player state change logs when music is played/paused *from another Spotify client* (e.g., Spotify desktop app) while the web app is open (to verify `player_state_changed` listener).
        - Any SDK error messages.
    - Use React DevTools to inspect the `MusicContext` state and verify `deviceId`, `isReady`, and `playbackState` are updated correctly.
- _(Hint: See `docs/testing-strategy.md` for the overall approach)_

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:**
  - Initial Draft 