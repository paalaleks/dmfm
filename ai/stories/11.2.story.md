# Story 11.2: Implement Timeline Display & Volume Popover in PlayerUI

**Status:** Approved

## Goal & Context

**User Story:** As a listener, I want to see a progress bar for the current song and drag or click it to seek, and access volume controls through a pop-over, so that I can jump to any point in the track, manage volume easily, and enjoy a cleaner interface.

**Context:** This story builds directly on Story 11.1, which added timeline state (`trackPositionMs`, `trackDurationMs`) and the `seek()` capability to `MusicContext`. This story focuses on the UI implementation within the `PlayerUI` component to display the timeline, enable seeking, and refactor the volume controls into a pop-over. It is a major part of Epic 11.

## Detailed Requirements

Refactor `PlayerUI.tsx` to integrate the new timeline and volume popover features.
1.  Display a timeline bar showing:
    *   Elapsed time on the left (mm:ss format).
    *   Total track duration on the right (mm:ss format).
    *   A draggable slider thumb reflecting the current playback position.
2.  The slider position must update in real-time (≤ 500 ms lag) while playing and stop when paused, reflecting values from `MusicContext`.
3.  Dragging or clicking the slider must call the `seek(positionMs)` method from `MusicContext`. The seek action should be triggered on pointer/touch release to avoid API spamming.
4.  If no track is loaded, the timeline should be disabled and display `0:00 / ––`.
5.  The existing volume slider and mute toggle will be moved into a new `VolumePopover` component.
6.  The `VolumePopover` is triggered by a speaker icon button.
7.  The pop-over must auto-close on an outside click.
8.  UI must remain responsive on desktop (≥ 320px) and mobile, with the timeline shrinking gracefully.
9.  Ensure accessibility:
    *   Timeline slider: `role="slider"`, `aria-valuemin`, `aria-valuemax`, `aria-valuenow`.
    *   Volume popover and its controls must be keyboard accessible.

## Acceptance Criteria (ACs)

- **AC1:** `PlayerUI` displays a timeline with current time, total duration, and a slider reflecting `trackPositionMs` and `trackDurationMs` from `MusicContext`.
- **AC2:** Timeline slider updates visually in real-time during playback and pauses when playback is paused.
- **AC3:** Clicking or dragging the timeline slider thumb calls `musicContext.seek(newPositionMs)` with the correct millisecond value on release.
- **AC4:** When `trackDurationMs` is null (no track), timeline displays `0:00 / ––` and slider is disabled.
- **AC5:** A speaker icon button is present in `PlayerUI`. Clicking it opens/closes a `Popover` containing the volume slider and mute button.
- **AC6:** The `VolumePopover` correctly controls volume and mute status via `MusicContext`.
- **AC7:** The `VolumePopover` auto-closes when clicking outside of it.
- **AC8:** Timeline and volume controls are responsive and usable on screens >= 320px wide.
- **AC9:** Both timeline and volume sliders have correct ARIA attributes (`role`, `aria-valuemin`, `aria-valuemax`, `aria-valuenow`) and are keyboard operable.
- **AC10:** All existing Player controls (play/pause, next, prev, shuffle, repeat) remain functional.
- **AC11:** All relevant unit/integration tests pass.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. `MusicContext` (from Story 11.1) provides `trackPositionMs`, `trackDurationMs`, and `seek()`.

- **Relevant Files:**
  - Files to Create:
    - `components/player/VolumePopover.tsx` (or similar, e.g., `components/custom/VolumePopover.tsx` if intended for wider reuse, but `player` sub-directory seems more appropriate given `PlayerUI` context).
  - Files to Modify:
    - `components/player/PlayerUI.tsx` (main component for this story)
    - Potentially `components/player/PlayerControls.tsx` if volume was part of it and needs removal/refactoring.
    - `hooks/useMusicPlayer.ts` (if it currently handles volume display logic that needs to move).

- **Key Technologies:**
  - React, TypeScript, Tailwind CSS
  - Shadcn UI components:
    - `Slider` (`@/components/ui/slider`) for the timeline.
    - `Popover`, `PopoverTrigger`, `PopoverContent` (`@/components/ui/popover`) for the volume control.
    - `Button` (`@/components/ui/button`) for the speaker icon trigger.
  - Icons (e.g., from `lucide-react` for speaker icon).

- **API Interactions / SDK Usage:**
  - Consuming `MusicContext`: `trackPositionMs`, `trackDurationMs`, `seek(positionMs)`, `volume`, `setVolume`, `isMuted`, `toggleMute`.

- **UI/UX Notes:**
  - Timeline:
    - Format time as `mm:ss`. Create a utility function if one doesn't exist (e.g., in `lib/utils.ts`).
    - Ensure slider thumb is styled appropriately.
  - Volume Popover:
    - Use a speaker icon (e.g., `Volume2`, `VolumeX` if muted from `lucide-react`).
    - Popover should appear near the speaker icon button.
    - Ensure the popover content (slider, mute toggle) is styled consistently with the application.

- **Data Structures:**
  - No new data structures. Will use existing state from `MusicContext`.

- **Environment Variables:**
  - None specific to this story.

- **Coding Standards Notes:**
  - Follow standards in `docs/coding-standards.md`.
  - Ensure `useEffect` hooks for subscriptions to `MusicContext` values have correct dependencies.
  - Debounce/throttle slider `seek` calls if necessary, though the "on release" requirement should mitigate API spam. `MusicContext.seek` itself (from Story 11.1) should already handle debouncing if it was deemed necessary there.

## Tasks / Subtasks

- [X] **Setup & Context Integration:**
  - [X] In `PlayerUI.tsx`, access `trackPositionMs`, `trackDurationMs`, and `seek` from `MusicContext`.
- [X] **Timeline Implementation (`PlayerUI.tsx`):**
  - [X] Add state for the slider's current value to allow smooth dragging, which syncs with `trackPositionMs` but updates optimistically during drag.
  - [X] Create a utility function `formatTime(ms: number | null): string` that returns "mm:ss" or "––" if ms is null/undefined.
  - [X] Display formatted `trackPositionMs` (current time) and `trackDurationMs` (total time).
  - [X] Implement the Shadcn UI `Slider` component.
    - [X] Set `min` to 0, `max` to `trackDurationMs`.
    - [X] Set `value` based on `trackPositionMs` (or the local drag state).
    - [X] On slider `onValueChange` (or equivalent for drag), update local drag state.
    - [X] On slider `onValueCommit` (or equivalent for release/click), call `musicContext.seek()` with the new value.
  - [X] Disable the slider and show "0:00 / ––" if `trackDurationMs` is null or 0.
  - [X] Style the timeline, labels, and slider appropriately using Tailwind CSS. Ensure responsiveness.
- [X] **Volume Popover Component (`VolumePopover.tsx`):**
  - [X] Create `VolumePopover.tsx`.
  - [X] It should take `volume`, `setVolume`, `isMuted`, `toggleMute` from `MusicContext` as props or access them directly from context.
  - [X] Use Shadcn UI `Popover`, `PopoverTrigger`, `PopoverContent`.
  - [X] `PopoverTrigger` will be a `Button` with a speaker icon (e.g., `Volume2` from `lucide-react`, changing to `VolumeX` if `isMuted`).
  - [X] `PopoverContent` will contain:
    - [X] The existing volume `Slider` logic (from `MusicContext`: `volume`, `setVolume`).
    - [X] The existing mute `Button` or `Switch` logic (from `MusicContext`: `isMuted`, `toggleMute`).
  - [X] Ensure the popover auto-closes on outside click (Shadcn `Popover` default behavior, verify).
  - [X] Style the popover and its contents.
- [X] **Integrate `VolumePopover` into `PlayerUI.tsx`:**
  - [X] Remove the old volume slider and mute button from `PlayerUI.tsx`.
  - [X] Add the new `VolumePopover` component.
- [ ] **Accessibility:**
  - [X] Add `role="slider"`, `aria-valuemin`, `aria-valuemax`, `aria-valuenow` to the timeline `Slider`.
  - [X] Ensure the volume `Slider` within the popover also has correct ARIA attributes.
  - [ ] Verify keyboard navigation and operation for both sliders and the popover itself.
- [ ] **Testing:**
  - [ ] Manually test all ACs.
  - [ ] (Optional, if dev time allows) Write Jest/RTL unit tests for:
    - Correct time formatting.
    - `seek` being called on slider interaction.
    - Popover opening/closing and controls functioning.

## Testing Requirements

**Guidance:** Verify implementation against the ACs. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests (Consider if time permits):**
  - Test `formatTime` utility.
  - Mock `MusicContext` and verify that `PlayerUI` correctly renders time, slider position.
  - Test that `seek` is called with the correct value from `PlayerUI` when timeline slider is used.
  - Test that `VolumePopover` opens/closes and that volume/mute controls within it call context functions.
- **Manual Verification (Primary):**
  1. Load a track: Verify timeline shows correct current time and total duration, updating live.
  2. Pause track: Verify timeline numbers and slider thumb stop updating.
  3. Drag timeline slider: Verify it moves smoothly and on release, playback jumps to the new position. Current time updates.
  4. Click on timeline: Verify playback jumps.
  5. No track loaded: Verify timeline shows "0:00 / ––" and is disabled.
  6. Volume Popover:
     - Click speaker icon: Verify popover opens.
     - Click outside popover: Verify it closes.
     - Adjust volume slider in popover: Verify playback volume changes.
     - Click mute toggle in popover: Verify sound mutes/unmutes and icon changes if implemented.
  7. Responsiveness: Resize browser window to ~320px width and verify layout is acceptable and usable.
  8. Keyboard Accessibility:
     - Tab to timeline slider, use arrow keys to adjust. Verify `seek` fires on change.
     - Tab to speaker icon, press Enter/Space to open popover.
     - Tab to volume slider in popover, use arrow keys to adjust.
     - Tab to mute button in popover, press Enter/Space to toggle.
  9. Verify all other player controls (play/pause, next, etc.) still work.

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:** {Track changes _within this specific story file_ if iterations occur}
  - Initial Draft 