# Story 2.4: Develop Initial Taste Comparison Logic

**Status:** Done

## Goal & Context

**User Story:** As the system, I need a mechanism to compare the music tastes of two users based on their stored Spotify data, so that I can identify potential matches for dynamic room assignment or playlist recommendations.

**Context:** This story provides the foundational logic for comparing user tastes (FR18, FR21). It builds upon Story 2.2, which fetches and stores user top artists and tracks. Initially, this comparison will rely solely on the data in the `user_top_artists` and `user_top_tracks` tables. Playlist data from the skipped Story 2.3 is not included in this scope but can be integrated later.

## Detailed Requirements

1.  Create server-side functions (likely in a new utility or action file, e.g., `lib/utils/taste-comparison.ts` or `lib/actions/taste-comparison.ts`) to perform taste comparison between two users.
2.  The primary comparison function should accept two user IDs as input.
3.  Inside the function, fetch the top artists and/or top tracks for both users from the `user_top_artists` and `user_top_tracks` tables in the database.
4.  Implement a basic similarity calculation algorithm. Suggested initial approach: **Jaccard Index** based on the overlap of **top artist Spotify IDs**.
    *   Jaccard Index = (Number of shared top artists) / (Total number of unique top artists across both users)
5.  The function should return a similarity score (e.g., a number between 0 and 1).
6.  Consider creating a helper function or modifying the main one to also return a boolean indicating if the similarity score meets a predefined threshold (e.g., > 0.05 for a 5% overlap, as mentioned in PRD FR18). This threshold might be configurable later.
7.  Handle edge cases gracefully, such as when one or both users have no top artist/track data stored.

## Acceptance Criteria (ACs)

- AC1: A server-side function (e.g., `calculateTasteSimilarity`) exists that accepts two user IDs.
- AC2: The function correctly fetches top artist data for both users from the `user_top_artists` table.
- AC3: The function correctly calculates the Jaccard Index based on shared top artist Spotify IDs.
- AC4: The function returns a similarity score between 0 and 1.
- AC5: The function handles cases where one or both users have no top artist data, returning an appropriate score (e.g., 0).
- AC6: (Optional but recommended) A related function or logic exists to determine if the similarity score meets a predefined threshold (e.g., 5%).

## Technical Implementation Context

**Guidance:** Implement the comparison logic server-side. Follow project standards.

- **Relevant Files:**
  - Files to Create: `lib/utils/taste-comparison.ts` (recommended for reusable logic) or `lib/actions/taste-comparison.ts`.
  - Files to Modify: None directly for this story, but the created functions will be called by other features later (e.g., dynamic room assignment logic).

- **Key Technologies:**
  - TypeScript
  - Supabase Client (Server-side)

- **API Interactions / SDK Usage:**
  - Supabase Client: `supabase.from('user_top_artists').select('artist_spotify_id').eq('user_id', ...)`

- **UI/UX Notes:**
  - No UI changes in this story.

- **Data Structures:**
  - Input: `userId1: string`, `userId2: string`.
  - Uses `user_top_artists` table structure (specifically `user_id`, `artist_spotify_id`).
  - Output: `similarityScore: number` (between 0 and 1).

- **Environment Variables:**
  - None specific to this story.

- **Coding Standards Notes:**
  - Follow standards in `docs/coding-standards.md`.
  - Aim for pure functions for the core calculation logic where possible.
  - Ensure efficient database queries (only select needed columns).

## Tasks / Subtasks

*Initial tasks based on requirements, agent may add/modify*
- [ ] Task 1: Create the file for the comparison logic (e.g., `lib/utils/taste-comparison.ts`).
- [ ] Task 2: Define the main function signature (e.g., `calculateTasteSimilarity(userId1: string, userId2: string): Promise<number>`).
- [x] Task 3: Implement logic within the function to fetch top artist IDs for both users from Supabase.
- [x] Task 4: Implement the Jaccard Index calculation based on the fetched artist ID sets.
- [x] Task 5: Handle edge cases (no data for one/both users).
- [x] Task 6: (Optional) Implement threshold check logic.
- [x] Task 7: Add basic unit tests for the Jaccard Index calculation with mock data.

## Testing Requirements

**Guidance:** Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:**
  - Test the core Jaccard Index calculation function with various inputs:
    - Identical sets of artist IDs (should return 1).
    - Completely disjoint sets (should return 0).
    - Partially overlapping sets (verify calculation manually).
    - Empty sets for one or both users (should return 0).
- **Integration Tests:**
  - Not strictly required if unit tests cover calculation and DB fetching is standard. Could test the main function against a test DB if desired.
- **Manual/CLI Verification:**
  - Ensure at least two users have top artist data populated (via Story 2.2 / OAuth login trigger).
  - Manually call the main comparison function (e.g., from a temporary test script or route) with the IDs of those users.
  - Verify the returned similarity score seems reasonable based on their known top artists (can check manually in DB).

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:**
  - Initial Draft