# Story 3.2: Implement Basic Player UI (Display track info, play/pause)

**Status:** Done

## Goal & Context

**User Story:** As a user, I want to see the currently playing track information (image, name, artist) and be able to play or pause the music, so that I can understand what's playing and control the basic playback state.

**Context:** This story builds directly upon Story 3.1, which set up the `MusicContext` and initialized the Spotify Web Playback SDK. This story focuses on creating the initial visible UI elements for the player, consuming state from the `MusicContext` (specifically `playbackState`) to display track details, and adding the fundamental play/pause control functionality by interacting with the `Spotify.Player` instance provided by the context. This addresses parts of FR8 and FR9.

## Detailed Requirements

*   Create a new `player` component (or similar name).
*   This component should consume the `MusicContext` using the `useMusic` hook.
*   Display the album art, track name, and primary artist name of the currently playing track based on the `playbackState` from the context.
*   Provide a button that toggles between Play and Pause functionality.
*   The button's state (displaying Play or Pause icon/text) should reflect the current `paused` status from the `playbackState`.
*   Clicking the Play/Pause button should call the appropriate method on the `Spotify.Player` instance (e.g., `player.togglePlay()`).
*   The `PlayerUI` component should handle cases where `playbackState` or `playbackState.track_window.current_track` is null (e.g., display nothing, a placeholder, or a "nothing playing" message).
*   Place the `PlayerUI` component in a suitable location within the main application layout (e.g., a persistent footer or sidebar defined in `app/(main)/layout.tsx`).

## Acceptance Criteria (ACs)

- AC1: A `player.tsx` component file is created (e.g., in `components/player/` or `app/(main)/components/player/`).
- AC2: The `player` component correctly uses the `useMusic` hook to access context state (`playbackState`, `player`, `isReady`, `deviceId`).
- AC3: When music is playing via the SDK, the component displays the current track's album art, name, and artist(s).
- AC4: The component displays a Play/Pause button whose appearance correctly reflects the current `paused` state from `playbackState`.
- AC5: Clicking the Play/Pause button successfully calls `player.togglePlay()` on the player instance from the context (verified via console logs or observed playback state change).
- AC6: The component handles the state where no track is playing or `playbackState` is null gracefully (e.g., displays placeholder or nothing).
- AC7: The `PlayerUI` component is rendered within the main application layout (`app/(main)/layout.tsx`), making it visible across relevant pages.
- AC8: The Play/Pause button is disabled if the player is not ready (`isReady` is false) or if there's no active device (`deviceId` is null).

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Refer to the linked `docs/` files for broader context if needed.

- **Relevant Files:**
  - Files to Create: `components/player/player.tsx` (or similar path)
  - Files to Modify: `app/(main)/layout.tsx` (to include the `<PlayerUI />` component)
  - _(Hint: See `docs/project-structure.md` for overall layout)_

- **Key Technologies:**
  - React (Hooks: `useContext`, `useState`, `useEffect`)
  - Next.js (Client Components)
  - TypeScript
  - `MusicContext` (from `context/MusicContext.tsx`, accessed via `useMusic` hook)
  - Spotify Web Playback SDK (`player.togglePlay()`)
  - Shadcn UI / Tailwind CSS (for UI elements like `Button`, `Avatar` or `img` for album art)
  - _(Hint: See `docs/tech-stack.md` for full list)_

- **API Interactions / SDK Usage:**
  - `useMusic` hook to get `player`, `playbackState`, `isReady`, `deviceId`.
  - `player?.togglePlay()`: Call this method on the player instance obtained from context.
  - Accessing fields within `playbackState`: `playbackState.paused`, `playbackState.track_window.current_track.name`, `playbackState.track_window.current_track.artists`, `playbackState.track_window.current_track.album.images`.
  - _(Hint: See `docs/api-reference.md` for external APIs and SDKs)_

- **UI/UX Notes:**
  - Use appropriate Shadcn UI components (`Button`, `Avatar`/`img`, potentially `Tooltip`).
  - Display a suitable icon (e.g., Play icon, Pause icon) on the button based on the `paused` state.
  - Ensure clear visual indication if the button is disabled (e.g., when `!isReady`).
  - Handle potential missing album art gracefully (e.g., show a placeholder).

- **Data Structures:**
  - Use `MusicContextState` and `Spotify.PlaybackState` types from `MusicContext.tsx` and `@types/spotify-web-playback-sdk`.

- **Environment Variables:** None specific to this story.

- **Coding Standards Notes:**
  - Component should be a Client Component (`'use client';`).
  - Add checks for `player` and `playbackState` existence before accessing their properties.
  - Use optional chaining (`?.`) extensively when accessing nested properties in `playbackState`.
  - _(Hint: See `docs/coding-standards.md` for full standards)_

## Tasks / Subtasks

- [x] **Task 1:** Create the basic `player.tsx` component file and structure (`'use client';`, default export).
- [x] **Task 2:** Import and use the `useMusic` hook within `PlayerUI` to retrieve context state (`player`, `playbackState`, `isReady`, `deviceId`).
- [x] **Task 3:** Implement rendering logic for album art (using `playbackState.track_window.current_track.album.images[0].url` or similar, with fallback). Use Shadcn `Avatar` or `img` tag.
- [x] **Task 4:** Implement rendering logic for track name and artist name(s) (using `playbackState.track_window.current_track.name` and `playbackState.track_window.current_track.artists`).
- [x] **Task 5:** Implement the Play/Pause button (using Shadcn `Button`).
    - [x] Display Play or Pause icon/text based on `playbackState.paused`.
    - [x] Disable the button if `!isReady` or `!player` or `!deviceId`.
- [x] **Task 6:** Implement the `onClick` handler for the Play/Pause button to call `player?.togglePlay()`. Include error handling for the call if necessary.
- [x] **Task 7:** Add conditional rendering logic to handle null `playbackState` or `current_track`.
- [x] **Task 8:** Add the `<Player />` component to the `app/(main)/layout.tsx` file, likely positioned fixed at the bottom or within a designated layout area.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

- **Unit Tests:** (Future) Test the component's rendering logic based on different mocked `playbackState` props. Test that the button's `onClick` correctly calls a mocked `togglePlay` function.
- **Integration Tests:** (Future) Test the component interacting with the actual `MusicContext` provider (potentially with a mocked player instance).
- **Manual/CLI Verification:**
    - Log in with Spotify.
    - Play music on Spotify from another client (e.g., desktop app) to activate the player context.
    - Verify the `PlayerUI` component appears in the layout.
    - Verify the correct album art, track name, and artist name are displayed.
    - Verify the Play/Pause button shows the correct state (Play if paused, Pause if playing).
    - Click the Play/Pause button and verify that playback toggles on Spotify.
    - Verify the button becomes disabled if the player is not ready (e.g., before the 'ready' event fires, might be hard to catch manually) or if the associated device goes offline (disconnect Spotify on the test device).
    - Stop playback entirely on Spotify and verify the component handles the null state gracefully.
- _(Hint: See `docs/testing-strategy.md` for the overall approach)_

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:**
  - Initial Draft 