# Story 3.8: Implement Spotify Token Refresh Mechanism

**Status:** Ready

## Goal & Context

**User Story:** As a user, I want the application to automatically refresh my Spotify connection when it expires, so that I can continue using the Spotify player features without interruption and without needing to manually re-authenticate.

**Context:** This story directly addresses FR14 ("The system must handle Spotify token refresh mechanisms.") from Epic 3. It's critical because the previous implementation was broken, leading to user disruption. This story builds upon Story 3.1 (SDK & MusicContext Setup) by making the Spotify integration robust against token expiry. It ensures that the `MusicContext` can reliably obtain valid Spotify access tokens for all player operations. The Supabase user's `raw_user_meta_data` (containing `provider_token`, `provider_refresh_token`, `provider_token_expires_at`) is the source and target for these tokens.

## Detailed Requirements

(Derived from FR14 and research findings)
*   Implement a server-side Next.js API route (e.g., `/api/spotify/refresh-token`) to handle Spotify token refresh.
*   This API route must securely retrieve the current user's Spotify `provider_refresh_token` from their Supabase `raw_user_meta_data`.
*   The API route will make a POST request to `https://accounts.spotify.com/api/token` with `grant_type: 'refresh_token'`, the `refresh_token`, and authenticate using `SPOTIFY_CLIENT_ID` and `SPOTIFY_CLIENT_SECRET`.
*   Upon successful refresh, the API route must update the `provider_token` (new access token) and `provider_token_expires_at` (new expiry timestamp) in the user's Supabase `raw_user_meta_data`. If Spotify returns a new `refresh_token`, that should also be updated.
*   The API route should return the new `access_token` and its `expires_at` timestamp (absolute Unix timestamp in seconds) to the client.
*   The client-side `MusicContext` (`music-context/music-context.tsx`) must be enhanced to:
    *   Detect when a Spotify access token is expired or nearing expiry (using `provider_token_expires_at`), or when a Spotify API call fails with a 401 Unauthorized status.
    *   Call the `/api/spotify/refresh-token` Next.js API route.
    *   Update its internal state (specifically `tokenRef.current` and any other relevant state) with the new `access_token` and ensure the `userSession` state reflects the latest token info for consistency.
    *   Retry any Spotify API call that failed due to token expiry, using the new token.
*   Ensure robust error handling for both the API route and client-side logic (e.g., if the refresh token itself is invalid, guide the user towards re-authentication).

## Acceptance Criteria (ACs)

- AC1: A Next.js API route (e.g., `/pages/api/spotify/refresh-token.ts` or `/app/api/spotify/refresh-token/route.ts`) is created.
- AC2: The API route successfully retrieves the `provider_refresh_token` from the authenticated Supabase user's `raw_user_meta_data`.
- AC3: The API route correctly calls the Spotify token endpoint (`https://accounts.spotify.com/api/token`) with `grant_type: 'refresh_token'`, `refresh_token`, and authenticates using `SPOTIFY_CLIENT_ID` and `SPOTIFY_CLIENT_SECRET` (e.g., via Basic Auth header).
- AC4: The API route updates the `provider_token` and `provider_token_expires_at` (and `provider_refresh_token` if changed by Spotify) in the Supabase user's `raw_user_meta_data` upon successful refresh.
- AC5: The API route returns the new `access_token` and its absolute expiry timestamp (`expires_at`) to the client.
- AC6: `MusicContext` (`music-context/music-context.tsx`) includes logic to call the refresh API route when a token is needed and suspected to be expired (e.g., via `getValidSpotifyToken` or `getOAuthToken`) or a 401 error occurs during a Spotify API call.
- AC7: `MusicContext` updates its internal token reference (`tokenRef.current`) and potentially the broader `userSession` state upon successful refresh. It enables retrying failed Spotify operations.
- AC8: If Spotify refresh fails because the `provider_refresh_token` is invalid, the system gracefully handles this (e.g., logs error, clears relevant token from context, potentially signals UI to prompt for re-login).
- AC9: `SPOTIFY_CLIENT_ID` and `SPOTIFY_CLIENT_SECRET` are securely accessed from environment variables in the API route and are not exposed client-side.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`.

**Important Note on Previous Implementation:** Be aware that a previous attempt to implement token refresh may have left behind files or functions with similar names. Specifically, review `music-context/user-session.ts` and `music-context/spotify-refreshtoken.ts` (and any related API routes like `music-context/music-context.tsx` or token utility functions). Please carefully review and replace or refactor any such old code to align with this story's requirements.

- **Relevant Files:**
  - Files to Create: `/pages/api/spotify/refresh-token.ts` (assuming Pages Router; adjust if App Router is used for API routes).
  - Files to Modify: `music-context/music-context.tsx`, `music-context/user-session.ts` (or equivalent logic that feeds `spotifyToken` and its expiry to `MusicContext`).

- **Key Technologies:**
  - Next.js (API Routes)
  - TypeScript
  - Supabase Server-Side Client (e.g., from `@supabase/auth-helpers-nextjs` or `@supabase/ssr` for user session and updates).
  - `node-fetch` (or built-in `fetch` if Node version supports it well for this, or `axios`) for the server-to-Spotify HTTP POST request.
  - React (Context API, Hooks in `MusicContext`).

- **API Interactions / SDK Usage:**
  - **Spotify API:** `POST https://accounts.spotify.com/api/token`
    - Headers: `Content-Type: application/x-www-form-urlencoded`, `Authorization: Basic <base64encode(SPOTIFY_CLIENT_ID:SPOTIFY_CLIENT_SECRET)>`
    - Body (form-urlencoded): `grant_type=refresh_token&refresh_token=<TOKEN_FROM_SUPABASE_METADATA>&client_id=<SPOTIFY_CLIENT_ID>` (Note: client_id in body is sometimes redundant if in Basic Auth but Spotify docs sometimes show it).
  - **Supabase Client (in API Route):**
    - Retrieve user: e.g., `const { data: { user } } = await supabase.auth.getUser();`
    - Access metadata: `user.raw_user_meta_data.provider_refresh_token` (and other related fields like `provider_token_expires_at`).
    - Update metadata: `await supabase.auth.updateUser({ data: { provider_token: new_access_token, provider_token_expires_at: new_expires_at_ts, provider_refresh_token: new_provider_refresh_token_if_any } });`

- **UI/UX Notes:**
  - Primarily a background mechanism. UI feedback might be needed if re-authentication becomes necessary due to an invalid refresh token.

- **Data Structures:**
  - Supabase `raw_user_meta_data` (ensure these field names match your existing data as per `epic3.md` comments):
    *   `provider_token: string`
    *   `provider_refresh_token: string`
    *   `provider_token_expires_at: number` (Unix timestamp in seconds)
  - Spotify Refresh Response: `{ access_token: string, token_type: string, scope: string, expires_in: number, refresh_token?: string }`

- **Environment Variables:**
  - `SPOTIFY_CLIENT_ID` (Server-side for API route)
  - `SPOTIFY_CLIENT_SECRET` (Server-side for API route)
  - `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY` (already in use)
  - `SUPABASE_SERVICE_ROLE_KEY` (Should NOT be needed if `updateUser` for `raw_user_meta_data` works with user's own session context from server-side helper).

- **Coding Standards Notes:**
  - Follow standards in `docs/coding-standards.md`.
  - Securely handle client secrets.
  - Convert Spotify's `expires_in` (seconds) to an absolute Unix timestamp (`Date.now()/1000 + expires_in`) for `provider_token_expires_at`.
  - Implement comprehensive, distinct error handling for network issues, Spotify API errors (e.g., `invalid_grant`), and Supabase update errors.

## Tasks / Subtasks

- [x] **Task 1:** Develop the Next.js API route `/api/spotify/refresh-token.ts`.
    - [x] Initialize Supabase server-side client.
    - [x] Retrieve authenticated user and their `provider_refresh_token` from `raw_user_meta_data`. 
    - [x] Handle missing `provider_refresh_token` (return 401/400).
    - [x] Construct and execute `POST` request to Spotify's token endpoint with `grant_type=refresh_token`, the token, and `Authorization: Basic <base64(CLIENT_ID:CLIENT_SECRET)>` header (using `SPOTIFY_CLIENT_ID` and `SPOTIFY_CLIENT_SECRET` from env).
    - [x] On Spotify success: Calculate new `provider_token_expires_at`. Update Supabase `raw_user_meta_data` with new `provider_token`, `provider_token_expires_at`, and `provider_refresh_token` (if Spotify returned a new one). Return new `access_token` and `expires_at` (absolute timestamp) in JSON response.
    - [x] On Spotify error (e.g., `invalid_grant`): Return appropriate error (e.g., 401).
    - [x] Handle any other errors (network, Supabase update).
- [x] **Task 2:** Enhance `MusicContext` (`music-context/music-context.tsx`) and `user-session.ts`.
    - [x] Modify `getValidSpotifyToken` (in `user-session.ts`) to:
        *   Check `provider_token_expires_at` from the session/user data against current time (with a small buffer).
        *   If expired or nearing expiry, call the new `/api/spotify/refresh-token` API route.
        *   On successful refresh from API route, update the local session/state (e.g. `tokenRef.current` in `MusicContext` and ensure `userSession` state in `MusicProvider` gets updated if it holds these values directly). The API route already updates Supabase; this is about client-side sync.
        *   Return the new (or still valid) `access_token`.
    - [x] Ensure `getOAuthToken` in `MusicProvider` uses this enhanced `getValidSpotifyToken`.
    - [x] Adapt existing Spotify API call wrappers (e.g., in `spotify-api.ts` or their callers in `MusicContext`) to:
        *   Catch 401 errors from Spotify.
        *   If 401, explicitly call `getValidSpotifyToken` (which should now force a refresh attempt) and then retry the original Spotify API call ONCE with the potentially new token.
        *   Handle persistent 401s after retry (e.g., log error, signal UI for re-authentication).
- [x] **Task 3:** Update Supabase `raw_user_meta_data` fields consistently.
    *   [x] Confirm field names used for storing `provider_token`, `provider_refresh_token`, and `provider_token_expires_at` are consistent with what `signInWithOAuth` initially stores and what the refresh API route updates.
- [ ] **Task 4:** Thoroughly test the refresh flow.
    - [ ] Test successful refresh after token expiry.
    - [ ] Test behavior when `provider_refresh_token` is invalid (Spotify should return `invalid_grant`).
    - [ ] Verify Supabase `raw_user_meta_data` is updated correctly.
    - [ ] Verify client-side context state is updated.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:**
    - Consider testing the expiry calculation logic and the logic for constructing the Spotify API request in the Next.js API route.
- **Integration Tests:**
    - Test the `/api/spotify/refresh-token` route:
        - Mock Supabase user retrieval and update.
        - Mock the `fetch` call to Spotify, simulating success and various error responses (e.g., `invalid_grant`).
        - Assert correct responses from the API route and correct parameters for Supabase update.
- **Manual/CLI Verification:**
    - Log into the application with Spotify. The initial `provider_token_expires_at` should be set in `raw_user_meta_data`.
    - Wait for the Spotify access token's `expires_in` duration (typically 1 hour) or manually set `provider_token_expires_at` in Supabase to a past timestamp for testing.
    - Attempt an action in the app that requires a Spotify API call (e.g., play a song, fetch user playlists via `MusicContext` if it exposes such a function).
    - **Observe:**
        - Network tab: A call to `/api/spotify/refresh-token` should occur. Subsequently, the Spotify API call should succeed.
        - Supabase Dashboard: Verify `raw_user_meta_data` for the user shows an updated `provider_token` and a new, future `provider_token_expires_at`.
    - **Test `invalid_grant`:** Manually corrupt the `provider_refresh_token` in Supabase for a user. Attempt an action requiring a token. Verify the refresh attempt fails and the application handles this gracefully (e.g., logs error, perhaps clears session data related to Spotify, requiring re-login for Spotify features).

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:**
  - Initial Draft
  - Added note about previous implementation attempts.