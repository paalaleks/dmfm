# Story 3.6: Implement Spotify Track Relinking Handling

**Status:** Done

## Goal & Context

**User Story:** As a user, I want the application to automatically handle unplayable tracks by finding and playing available alternatives, so my music streaming experience is uninterrupted and seamless across different regions or due to catalog changes.

**Context:** This story builds upon the foundational Spotify integration (Story 3.1) and playback functionalities (Stories 3.2-3.5). It addresses a key functional requirement (FR15) from Epic 3 to ensure robustness in music playback by handling Spotify track relinking. Successful implementation will improve user satisfaction by minimizing playback interruptions.

## Detailed Requirements

(Corresponds to FR15: The system must handle Spotify track relinking.)
*   The system must detect when a playing, selected, or queued track is unplayable in the user's current Spotify market (e.g., due to `is_playable: false` or market restrictions indicated in the track object).
*   When an unplayable track is identified, the system must check if Spotify provides a `linked_from` attribute in the track object, indicating an alternative (relinked) track.
*   If a relinked track ID is available, the system should fetch the details of this new track.
*   Playback should then proceed with the relinked track if it is playable in the user's market.
*   If the original track is unplayable and no relinked track is available or the relinked track is also unplayable, the system should provide appropriate feedback to the user (e.g., "This track is not available in your region") and may skip to the next available track in the playlist/queue.

## Acceptance Criteria (ACs)

*   **AC1:** When the application attempts to play a track that is marked as unplayable by Spotify (e.g., `track.is_playable === false` or not available in `track.available_markets`), it checks for a `track.linked_from.id`.
*   **AC2:** If `track.linked_from.id` exists, the system fetches the relinked track using this ID.
*   **AC3:** If the fetched relinked track is playable, the player UI updates with the new track's information, and playback commences with the relinked track.
*   **AC4:** If the original track is unplayable and no `linked_from.id` is present, or if the relinked track is also unplayable, the system informs the user of the unavailability and gracefully handles the situation (e.g., skips to the next track if in a playlist, or shows a persistent message).
*   **AC5:** The track relinking logic is integrated into the primary playback flow, affecting tracks played from playlists, search results, or any other source.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**
  - Files to Create: (Potentially none, if logic is added to existing services/contexts)
  - Files to Modify:
    - `MusicContext.tsx` (or equivalent Spotify player state management service): To incorporate relinking logic before initiating playback or when a track becomes unplayable.
    - Relevant UI components displaying track information or player state: To reflect changes or unavailability messages.
    - Spotify API service wrapper/functions: To ensure track objects are checked for playability and `linked_from` attributes.

- **Key Technologies:**
  - Spotify Web API (for fetching track details, including `linked_from` and `available_markets`).
  - Spotify Web Playback SDK (interactions might be indirect, via state updates).
  - React/TypeScript (for frontend logic).

- **API Interactions / SDK Usage:**
  - Utilize the Spotify API endpoint for fetching track details (e.g., `GET /v1/tracks/{id}`). Pay close attention to the `is_playable`, `available_markets`, and `linked_from` fields in the track object response.
  - The `linked_from` object contains the `id` of the relinked track.
  - Reference: [Spotify API Track Object Documentation](https://developer.spotify.com/documentation/web-api/reference/get-track)

- **UI/UX Notes:** 
    - When a track is successfully relinked, the transition should be as seamless as possible. The UI should update to display the information of the *new* (relinked) track.
    - If a track cannot be played and no relinked version is found/playable, display a clear, non-intrusive message to the user (e.g., a toast notification or a message in the player area like "Track unavailable").

- **Data Structures:**
  - The application's internal representation of a track (e.g., in `MusicContext`) should be able to accommodate updates if a track is relinked (e.g., original ID vs. played ID, updated metadata).

- **Environment Variables:** 
  - None specific to this story beyond existing Spotify API credentials.

- **Coding Standards Notes:**
  - Ensure robust error handling around API calls for fetching original and relinked tracks.
  - Follow standards in `docs/coding-standards.md`.

## Tasks / Subtasks

- [X] **Research & Design:**
  - [X] Thoroughly review Spotify's documentation on track relinking and market availability (`is_playable`, `available_markets`, `linked_from` fields).
  - [X] Design the flow for how and when track playability and relinking checks are performed (e.g., before adding to queue, right before playback).
- [ ] **Implementation:**
  - [X] Modify the Spotify API service/wrapper to consistently fetch and expose `is_playable`, `available_markets`, and `linked_from` attributes for tracks.
  - [X] Implement logic in `MusicContext` (or equivalent) to:
    - [X] Check `is_playable` status and market availability before attempting playback.
    - [X] If unplayable, check for `linked_from.id`.
    - [X] If `linked_from.id` exists, fetch the relinked track.
    - [X] If relinked track is playable, update the player state to use the relinked track's details and URI for playback.
    - [X] If no playable version (original or relinked) is found, trigger appropriate user feedback.
  - [X] Update UI components to correctly display information for relinked tracks.
  - [X] Implement UI feedback for tracks that are ultimately unplayable.
- [ ] **Testing:**
  - [ ] Develop unit tests for the relinking logic, mocking Spotify API responses for various scenarios (playable, unplayable with relink, unplayable with no relink, relinked track also unplayable).
  - [ ] Manually test with known tracks that might be subject to relinking or market restrictions (if possible to find/simulate).

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:** 
    - Test the core relinking logic in isolation:
        - Given an unplayable track with a valid `linked_from.id` that points to a playable track, verify the playable track's URI is used.
        - Given an unplayable track with a `linked_from.id` that points to another unplayable track, verify appropriate error/skip behavior.
        - Given an unplayable track with no `linked_from.id`, verify appropriate error/skip behavior.
        - Given a playable track, verify no relinking attempt is made.
- **Integration Tests:** (If feasible)
    - Test the interaction between the player service and the Spotify API mock for relinking scenarios.
- **Manual/CLI Verification:**
    - Attempt to play tracks known to be restricted in certain markets or that have been relinked (this may require finding specific examples or using a VPN to simulate different markets if your test account allows).
    - Observe UI behavior: track information updates, unavailability messages are displayed correctly.

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** Gemini 2.5 Pro (Story Generator)
- **Completion Notes:** Story 3.6 successfully completed as per user directive. Track relinking implemented.
- **Change Log:** {Track changes _within this specific story file_ if iterations occur}
  - Initial Draft
  - Status changed from Ready to Done. Completion details added. 