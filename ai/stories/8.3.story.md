# Story 8.3: Enhance User Taste Profile with Playlist Aggregate Artist Data

**Status:** Approved

## Goal & Context

**User Story:** As a developer, I want to modify the `getTasteMatchedPlaylistsAction` to incorporate artist data from the user's imported playlists (via `playlist_track_artist_aggregates.artists_json`) into their taste profile, so that playlist matching becomes more accurate by considering a broader set of their musical preferences.

**Context:** This story builds upon Story 8.1 (which created the `playlist_track_artist_aggregates` table) and Story 8.2 (which populated this table during playlist import). It refines the taste profiling logic currently implemented in `taste-matching/tastematched-playlists.ts` by leveraging the newly available aggregated artist data. The `user_id` column in `playlist_track_artist_aggregates` will be used to fetch the current user's relevant playlist aggregates.

## Detailed Requirements

Modify the `getTasteMatchedPlaylistsAction` server action, located in `taste-matching/tastematched-playlists.ts`, to enhance the user's taste profile. The enhancement involves:
1.  After fetching the user's top artists (from `user_top_artists` table via `getUserTopArtistIds`), query the `playlist_track_artist_aggregates` table.
2.  This query should retrieve all records where the `user_id` matches the ID of the currently authenticated user.
3.  From these records, extract the `artists_json` field.
4.  Parse each `artists_json` array to get all `spotify_artist_id` values.
5.  Combine these `spotify_artist_id`s with those obtained from `getUserTopArtistIds` into a single `Set<string>` representing the comprehensive `userTasteProfile`. This set should contain unique artist IDs.

## Acceptance Criteria (ACs)

- AC1: The `getTasteMatchedPlaylistsAction` in `taste-matching/tastematched-playlists.ts` is updated to query the `playlist_track_artist_aggregates` table for records where `user_id` matches the current authenticated user's ID.
- AC2: For each fetched record, `spotify_artist_id` values are correctly extracted from the `artists_json` field.
- AC3: The extracted artist IDs are merged with the artist IDs obtained from `getUserTopArtistIds` to form a single `userTasteProfile` (a `Set<string>`), ensuring no duplicate artist IDs.
- AC4: This new, comprehensive `userTasteProfile` is then used as the basis for calculating the Jaccard Index against candidate playlists.
- AC5: If a user has no entries in `user_top_artists` but has imported playlists with artists in `artists_json`, their `userTasteProfile` is populated solely from the `artists_json` data.
- AC6: If a user has neither `user_top_artists` entries nor relevant `playlist_track_artist_aggregates` records (or those records have empty/null `artists_json`), the `userTasteProfile` remains empty, and the function should proceed as it currently does (e.g., likely returning no matches).
- AC7: The function handles potential errors gracefully during the query to `playlist_track_artist_aggregates` (e.g., logs an error and potentially falls back to using only `getUserTopArtistIds`, or returns an empty list if a comprehensive profile cannot be built). The primary goal is to avoid outright failure of the action if this new data source is unavailable.
- AC8: Console logs are added for debugging purposes, specifically to trace the artist IDs fetched from `playlist_track_artist_aggregates` and the size/content of the combined `userTasteProfile`.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md`.

- **Relevant Files:**
  - Files to Create: None.
  - Files to Modify: `taste-matching/tastematched-playlists.ts`.

- **Key Technologies:**
  - TypeScript
  - Supabase Client (for querying `playlist_track_artist_aggregates`)

- **API Interactions / SDK Usage:**
  - Supabase client library for database operations (`select` query on `playlist_track_artist_aggregates`).

- **Data Structures:**
  - `artists_json` structure from `playlist_track_artist_aggregates` (as defined in Story 8.1):
    ```json
    [
      {
        "spotify_artist_id": "string",
        "name": "string",
        "playlist_occurrences": "integer"
      }
    ]
    ```
  - The `userTasteProfile` will be a `Set<string>` of `spotify_artist_id`s.

- **Environment Variables:**
  - None specific to this story beyond standard Supabase connection variables.

- **Coding Standards Notes:**
  - Follow TypeScript and project-specific coding standards outlined in `docs/coding-standards.md`.
  - Ensure error handling is robust.
  - The new logic should be integrated into the existing flow for building the `userTasteProfile`.

## Tasks / Subtasks

- [x] Locate the section in `taste-matching/tastematched-playlists.ts` where `userTasteProfile` is currently fetched/initialized using `getUserTopArtistIds`.
- [x] After `getUserTopArtistIds` is called, add a new Supabase client query to fetch `artists_json` from the `playlist_track_artist_aggregates` table, filtering by the current `user_id`.
- [x] Implement logic to iterate through the query results. For each record:
    - [x] Safely parse the `artists_json` field (it could be null or not an array).
    - [x] For each artist object in `artists_json`, extract the `spotify_artist_id`.
    - [x] Add each valid `spotify_artist_id` to the `userTasteProfile` Set.
- [x] Add comprehensive error handling for the new Supabase query and JSON parsing steps. Log errors appropriately.
- [x] Add console logs to show the number of artist IDs retrieved from aggregates and the final size of the `userTasteProfile`.
- [x] Ensure the rest of the `getTasteMatchedPlaylistsAction` uses the augmented `userTasteProfile`.

## Testing Requirements

**Guidance:** Verify implementation against the ACs. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:**
    - If any complex helper functions are created for parsing or merging, consider unit testing them with mock data.
- **Integration Tests:**
    - Test `getTasteMatchedPlaylistsAction` with various scenarios:
        - User has data in `user_top_artists` only.
        - User has data in `playlist_track_artist_aggregates.artists_json` only (ensure `user_id` is correctly associated).
        - User has data in both sources.
        - User has data in neither source.
        - User has `playlist_track_artist_aggregates` records but `artists_json` is empty or null.
    - Verify that the `userTasteProfile` Set within the function correctly reflects the combined artist IDs from all applicable sources.
    - Verify that the final list of matched playlists changes appropriately based on the more comprehensive taste profile.
- **Manual/CLI Verification:**
    - After deployment/setup, manually invoke the action or use a test script.
    - Check console logs for the new debugging information related to artist ID fetching and merging.
    - Inspect the returned playlists to qualitatively assess if the matching seems improved or at least influenced by the broader artist set.

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:**
- **Change Log:**
  - Initial Draft 