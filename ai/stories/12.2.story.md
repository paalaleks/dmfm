# Story 12.2: Integrate Custom Shuffle Option into Playlist UI

**Status:** Approved

## Goal & Context

**User Story:** As a user, I want a clear option in the UI to play a playlist using the custom shuffle mechanism so I can enjoy a truly random playback experience.

**Context:** This story builds upon the backend and context logic for custom playlist shuffling implemented in Story 12.1. It focuses on providing a user-facing control within the player UI to activate this new shuffle mode. This story addresses FR12.6 from Epic 12.

## Detailed Requirements

*   **DR12.2.1 (Corresponds to FR12.6):** The UI must present an option (e.g., a button or icon) within the main player controls to activate the "Custom Shuffle" for the currently playing playlist context.
*   **DR12.2.2:** Activating this option should call the `playPlaylistWithCustomShuffle(currentPlaylist)` method from `MusicContext`. The `currentPlaylist` object will need to be constructed using available information like `playbackState.context.uri` (for `spotify_id`) and `currentPlaylistName` from the `MusicContext`.
*   **DR12.2.3:** The visual design and placement of this option should be harmonious with the existing player UI (`components/player/player.tsx`), ideally positioned near other playback mode controls like the standard shuffle toggle.

## Acceptance Criteria (ACs)

- [x] AC1: A visible UI element (e.g., a shuffle icon, possibly distinct from any existing Spotify shuffle toggle) for "Custom Shuffle" is present in the player UI (`components/player/player.tsx`) when a playlist context is active. (Note: Existing shuffle icon repurposed)
- [x] AC2: Clicking/activating this UI element correctly identifies the current playlist's `spotify_id` (from `playbackState.context.uri`) and `name` (from `currentPlaylistName`), constructs a minimal `Playlist` object, and calls `musicContext.playPlaylistWithCustomShuffle()` with this playlist object.
- [x] AC3: The UI element is clear in its purpose (e.g., via tooltip "Play with Custom Shuffle"). (Note: Tooltip "Play with Enhanced Shuffle" implemented)
- [x] AC4: The UI element should be disabled if no playlist context is active or if essential information (like `deviceId` or `token`) is unavailable, consistent with other player controls.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`.

- **Relevant Files:**
  - Files to Create: None anticipated.
  - Files to Modify:
    - `components/player/player.tsx`: To add the new UI button/icon and its logic.
    - Potentially `music-context/music-context.tsx` if changes are needed to easily access the current playlist object or its essential parts (though the current plan is to construct it in `player.tsx`).

- **Key Technologies:**
  - React, TypeScript
  - `lucide-react` for icons (consider a distinct shuffle icon or styling if available/easy, otherwise reuse `Shuffle` with clear distinction).
  - `useMusic()` hook from `@/music-context/music-context`.

- **API Interactions / SDK Usage:**
  - Indirectly, via `musicContext.playPlaylistWithCustomShuffle(playlist)`, which then calls the Spotify API wrapper functions.

- **UI/UX Notes:**
  - The button should be placed within the main player control group in `components/player/player.tsx`.
  - A tooltip (e.g., "Enhanced Shuffle" or "Play with Custom Shuffle") should be used to clarify its function, especially if the icon is similar to the standard shuffle.
  - Consider conditional rendering: the button should only be active/visible when `playbackState.context.uri` indicates a playlist is the current context.

- **Data Structures:**
  - `Playlist` interface from `../types/spotify` (specifically `spotify_id` and `name` are needed for the call to `playPlaylistWithCustomShuffle`).

- **Environment Variables:** None specific to this story.

- **Coding Standards Notes:**
  - Follow standards in `docs/coding-standards.md`.
  - Ensure the new button has appropriate `disabled` states based on `isReady`, `player`, `deviceId`, `playbackState`, and `playbackState.context.uri`.

## Tasks / Subtasks

- [x] Design: Confirm icon and exact placement for the "Custom Shuffle" button within `components/player/player.tsx`. (For now, assume a `Shuffle` icon, potentially styled differently or with a clear tooltip, placed near the existing shuffle toggle). (Decision: Replaced existing shuffle button functionality, kept icon, added tooltip)
- [x] Implement UI: Add the new button/icon to `components/player/player.tsx`.
  - [x] Ensure it's visually distinct or clearly labeled (e.g. via tooltip "Enhanced Shuffle"). (Achieved via tooltip "Play with Enhanced Shuffle")
  - [x] Ensure it's disabled appropriately (e.g., if not a playlist context, or player not ready).
- [x] Implement Logic:
  - [x] On click, retrieve `playbackState.context.uri` and `currentPlaylistName` from `useMusic()`.
  - [x] Parse `spotify_id` from the URI.
  - [x] Construct a `Playlist` object: `{ spotify_id: string, name: string, id: string (can be same as spotify_id for this purpose), image_url?: string (optional) }`.
  - [x] Call `musicContext.playPlaylistWithCustomShuffle(constructedPlaylist)`.
- [x] Styling: Ensure the button integrates well with the existing player UI style. (Achieved by modifying existing button)

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:**
  - Consider tests for the logic that constructs the `Playlist` object from context state if it becomes complex.
  - Test that the button correctly calls `playPlaylistWithCustomShuffle` with the constructed playlist.
- **Integration Tests:** (Not explicitly required for this UI change, assuming context method is tested)
- **Manual/CLI Verification:**
  - Load a playlist.
  - Verify the "Custom Shuffle" button appears in the player controls.
  - Click the button.
  - Observe (e.g., via console logs from Story 12.1's functions or network tab) that:
    - `playPlaylistWithCustomShuffle` in `MusicContext` is called.
    - `playPlaylistWithCustomShuffleAPI` is called with the correct playlist ID.
    - Spotify's shuffle is turned off.
    - A play request with a list of URIs is made.
  - Verify a toast message appears if no playable tracks are found (requires a suitable test playlist).
  - Verify the button is disabled if no playlist is active in the player.

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** 
- **Change Log:**
  - Initial Draft 