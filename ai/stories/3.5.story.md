# Story 3.5: Implement Save Track/Follow Playlist Functionality

**Status:** In-Progress

## Goal & Context

**User Story:** As a user, I want to be able to save the currently playing track to my Spotify library and follow the currently playing playlist directly from the application, so I can easily curate my Spotify content based on what I discover.

**Context:** This story enhances the player interactions by adding features to save tracks (FR12) and follow playlists (FR13). It builds upon the `MusicContext` (Story 3.1) and the player UI (Stories 3.2, 3.3, 3.4). It requires interacting with the Spotify Web API to modify the user's library and followed playlists.

## Detailed Requirements

*   Implement functionality to allow users to save the currently playing track to their Spotify library.
*   Implement functionality to allow users to follow the currently playing playlist on Spotify.

## Acceptance Criteria (ACs)

- AC1: The `MusicContext` is updated to include methods for `saveCurrentTrack()` and `followCurrentPlaylist()`.
- AC2: The `Player` component renders a "Save Track" button (e.g., a heart icon) that, when clicked, successfully calls `saveCurrentTrack()` and saves the track to the user's Spotify library.
- AC3: The "Save Track" button's visual state (e.g., filled/empty heart) reflects whether the current track is already saved in the user's library.
- AC4: The `Player` component renders a "Follow Playlist" button that, when clicked, successfully calls `followCurrentPlaylist()` and follows the playlist on Spotify for the user.
- AC5: The "Follow Playlist" button's visual state reflects whether the current playlist is already followed by the user.
- AC6: Both buttons are disabled if the player is not ready, no track/playlist is active, or the necessary information (track ID, playlist ID) is unavailable.
- AC7: The system provides feedback to the user upon successful or failed save/follow operations (e.g., toast notification).

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`.

- **Relevant Files:**
  - Files to Modify: `context/music-context.tsx`, `components/player/player.tsx`
  - Potentially Files to Create/Modify: `lib/spotify-api.ts` (if new client-side Spotify API helper functions are needed for checking saved status or making calls).

- **Key Technologies:**
  - React (Context API, Hooks)
  - Next.js (Client Components)
  - TypeScript
  - Spotify Web API (via `@spotify/web-api-ts-sdk` or direct `fetch` calls using user's access token)
    - Check if track is saved: `GET /v1/me/tracks/contains?ids={track_id}`
    - Save track: `PUT /v1/me/tracks?ids={track_id}`
    - Unsave track: `DELETE /v1/me/tracks?ids={track_id}`
    - Check if playlist is followed: `GET /v1/playlists/{playlist_id}/followers/contains?ids={user_spotify_id}`
    - Follow playlist: `PUT /v1/playlists/{playlist_id}/followers`
    - Unfollow playlist: `DELETE /v1/playlists/{playlist_id}/followers`
  - Shadcn UI / Tailwind CSS (for UI elements like `Button`, icons)
  - `lucide-react` for icons (e.g., `Heart`, `PlusCircle`, `CheckCircle`)

- **API Interactions / SDK Usage:**
  - **In `MusicContext`:**
    - New methods: `saveCurrentTrack()`, `unsaveCurrentTrack()`, `followCurrentPlaylist()`, `unfollowCurrentPlaylist()`.
    - These methods will use the Spotify access token from the context to make authenticated API calls.
    - May also need `checkIfTrackIsSaved(trackId: string): Promise<boolean>` and `checkIfPlaylistIsFollowed(playlistId: string, userId: string): Promise<boolean>`.
  - Logic will involve:
    1. Getting current track ID / playlist ID from `playbackState` or `currentPlayingPlaylist` in context.
    2. Getting user's Spotify ID (may need to fetch/store this in `MusicContext` or `ProfileContext`

- [x] **Task 2: Update `Player` Component UI & Logic**
  - [x] Add "Save Track" button (e.g., heart icon).
    - [x] Visual state (filled/empty) based on `musicContext.isCurrentTrackSaved`.
    - [x] `onClick` calls `musicContext.saveCurrentTrack()` or `musicContext.unsaveCurrentTrack()`.
    - [x] Disable if no current track or player not ready.
  - [x] Add "Follow Playlist" button.
    - [x] Visual state (e.g., "Follow"/"Following") based on `musicContext.isCurrentPlaylistFollowed`.
    - [x] `onClick` calls `musicContext.followCurrentPlaylist()` or `musicContext.unfollowCurrentPlaylist()`.
    - [x] Disable if no current playlist or player not ready.
  - [x] Implement toast notifications for success/failure of save/follow actions.

## Testing Requirements