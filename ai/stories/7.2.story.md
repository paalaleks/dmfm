# Story 7.2: Implement Robust SDK `authentication_error` Handling

**Status:** Approved

## Goal & Context

**User Story:** As a developer, I want the application to reliably recover when the Spotify SDK reports an `authentication_error`, so that the user experiences minimal disruption and the player attempts to automatically re-establish a valid session.

**Context:** This story builds upon Epic 7's goal of improving Spotify SDK resilience. It directly tackles the `authentication_error` event, which is a common symptom of the issues described (e.g., after system sleep). A robust handler for this error is crucial for automated recovery. This story assumes that mechanisms for refreshing tokens (as detailed in Story 7.1) are available or will be used by the re-connection logic.

## Detailed Requirements

Develop a reliable recovery process when the Spotify SDK explicitly reports an `authentication_error`. This involves catching the error, updating application state, attempting a clean disconnect of the current player instance, and then initiating a full re-connection sequence.

## Acceptance Criteria (ACs)

- AC1: The `authentication_error` event emitted by the Spotify Web Playback SDK is caught by a dedicated event listener in the application's SDK integration hook (e.g., `useSpotifySDK.ts`).
- AC2: Upon catching an `authentication_error`, the application's internal state is updated to reflect this error (e.g., setting an `error` object with type `authentication_error`, setting `isReady = false`, `isActive = false`).
- AC3: The Spotify player instance's `disconnect()` method is called to cleanly terminate the current potentially faulty session.
- AC4: After a brief, controlled delay (if necessary for `disconnect()` to complete), a re-connection attempt is automatically initiated. This re-connection should trigger the full player initialization process, including the `getOAuthToken` flow (which should now benefit from Story 7.1's refresh capabilities).
- AC5: The `authentication_error` event details and the subsequent recovery attempt (initiation, success, or failure) are logged for debugging purposes.
- AC6: If re-connection fails after an `authentication_error`, the player remains in an error state, providing clear feedback if possible, rather than entering an infinite loop of re-connection attempts without backoff (advanced backoff is out of scope for this story but avoid immediate tight loops).

## Technical Implementation Context

**Guidance:** This story primarily involves modifications to the client-side Spotify SDK integration hook.

- **Relevant Files:**
  - Files to Modify:
    - `hooks/useSpotifySDK.ts` (or equivalent): Add/enhance the `authentication_error` listener and the logic to trigger disconnect and reconnect.
    - Potentially a shared logging utility if one exists.

- **Key Technologies:**
  - TypeScript
  - Spotify Web Playback SDK (specifically its event listening mechanism)
  - React (for state management within the hook)

- **API Interactions / SDK Usage:**
  - Spotify SDK `player.addListener('authentication_error', callback)`
  - Spotify SDK `player.disconnect()`
  - The application's own `connect()` or `initializePlayer()` function within the hook, which in turn uses `player.connect()` and the `getOAuthToken` callback (as refined in Story 7.1).

- **Data Structures:**
  - The hook's internal state for `error` should be able to store details from `WebPlaybackError` (type from Spotify SDK). Example:
    ```typescript
    interface SpotifyPlayerError {
      type: ErrorTypes | "initialization" | "token" | "authentication_error"; // Ensure 'authentication_error' is a valid type here
      message: string;
    }
    // playbackState: WebPlaybackState | null;
    // error: SpotifyPlayerError | null;
    ```

- **Environment Variables:** None specific to this story beyond those needed for the overall Spotify integration (Story 7.1).

- **Coding Standards Notes:**
  - Follow error handling patterns in `docs/coding-standards.md`.
  - Ensure logging provides sufficient context.
  - Avoid race conditions if multiple events could trigger re-connection; the re-connection logic should be somewhat idempotent or have flags.

## Tasks / Subtasks

- [ ] **In `useSpotifySDK.ts` (or equivalent):**
  - [ ] Add or verify an event listener for the SDK's `authentication_error`.
    ```typescript
    // playerInstance.addListener('authentication_error', (e: WebPlaybackError) => { ... });
    ```
  - [ ] Inside the listener:
    - [ ] Log the received error (`e.message`).
    - [ ] Update the hook's internal state: `setError({ type: 'authentication_error', message: e.message })`, `setIsReady(false)`, `setIsActive(false)`.
    - [ ] If `playerRef.current` exists, call `playerRef.current.disconnect()`.
    - [ ] After calling `disconnect`, and potentially a short timeout (e.g., 500ms, to allow SDK to process disconnect), call the main `connect()` or `initializePlayer()` function of the hook to attempt re-initialization and re-connection.
  - [ ] Review the existing `connect()` / `initializePlayer()` function to ensure it can be called to re-initialize the player cleanly, potentially after a `disconnect()`. It should go through the `new Spotify.Player()` and `player.connect()` sequence again.
- [ ] **Logging:**
  - [ ] Ensure clear logs are output when an `authentication_error` occurs.
  - [ ] Log the initiation of the recovery/re-connection attempt.
  - [ ] Log the outcome of the re-connection attempt (success or failure).

## Testing Requirements

**Guidance:** Focus on simulating `authentication_error` conditions.

- **Unit/Integration Tests (within the hook's context if possible, or manual):**
  - **Simulate `authentication_error`:**
    - If possible to mock/trigger this SDK event directly in a test environment.
    - Alternatively, by providing an invalid/expired token through a mocked `getOAuthToken` that leads the SDK to emit this error.
  - Verify that the error state in the hook is set correctly.
  - Verify that `player.disconnect()` is called.
  - Verify that the re-connection logic (`connect()`/`initializePlayer()`) is subsequently called.
  - Verify that logs are produced as expected.
- **Manual Verification:**
  - **Scenario 1: Induce Auth Error (if possible):**
    - Try to revoke application permissions from Spotify user settings, then interact with the player.
    - Use browser developer tools to manually modify a token to be invalid before it's sent to the SDK (if `getOAuthToken` is intercepted).
  - **Scenario 2: Test after wake-from-sleep (Primary Use Case):**
    - Authenticate and use the player.
    - Put the computer to sleep for a duration that typically causes token expiry or session invalidation (e.g., >1 hour).
    - Wake the computer and observe if an `authentication_error` occurs and if the recovery mechanism attempts to fix it.
  - Observe player state changes and error messages in the UI/console.

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:**
  - Initial Draft 