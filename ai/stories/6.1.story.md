# Story 6.1: Implement PostgreSQL Helper Function for Jaccard Index

**Status:** Done

## Goal & Context

**User Story:** As a system, I want a reliable way to calculate the similarity between arrays of text (specifically Spotify artist IDs), so that I can automatically identify playlists that match a user's taste.

**Context:** This is the first story in Epic 6, which focuses on implementing automated user-playlist taste matching. This story implements the foundational PostgreSQL helper function that will calculate the Jaccard Index, which measures the similarity between two sets (in our case, arrays of Spotify artist IDs). This function will be used by subsequent parts of the system to match playlists with users based on musical taste.

## Detailed Requirements

We need to implement a PostgreSQL helper function called `calculate_jaccard_index_text_arrays` that calculates the Jaccard Index (a standard similarity metric) between two arrays of text elements. The function will:

1. Accept two input parameters, both of type `TEXT[]` (arrays of text).
2. Calculate the Jaccard Index, which is defined as the size of the intersection divided by the size of the union of the two input arrays.
3. Return a `FLOAT` value between 0.0 and 1.0, where:
   - 0.0 indicates no similarity (no common elements)
   - 1.0 indicates identical sets (all elements are the same)
   - Values in between represent partial similarity

The function must handle edge cases such as NULL inputs, empty arrays, and other potential error conditions gracefully.

## Acceptance Criteria (ACs)

- AC1: The PostgreSQL function `calculate_jaccard_index_text_arrays` is successfully created in the database.
- AC2: The function accepts two input arrays of type `TEXT[]`.
- AC3: The function correctly handles edge cases:
  - Returns 0.0 when either input is NULL or empty.
  - Returns 0.0 when both inputs are empty.
  - Returns 1.0 when both inputs are identical and non-empty.
- AC4: The function correctly calculates the Jaccard Index for various test cases.
- AC5: The function is documented with appropriate comments.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**
  - Files to Create: N/A (This will be implemented as a SQL migration)
  - Files to Modify: N/A

- **Key Technologies:**
  - PostgreSQL function in PL/pgSQL
  - Supabase for executing the migration

- **API Interactions / SDK Usage:**
  - Supabase's `supabase-js` SDK for applying migrations
  - Project's Supabase reference: `jaoksbhfyfyqubkmjvso` (from supabase-project-ref)

- **Data Structures:**
  - Function will operate on `TEXT[]` arrays
  - The function will return a `FLOAT` value

- **SQL Implementation Details:**
  ```sql
  CREATE OR REPLACE FUNCTION public.calculate_jaccard_index_text_arrays(array1 TEXT[], array2 TEXT[])
  RETURNS FLOAT AS $$
  DECLARE
      intersection_count INTEGER;
      union_count INTEGER;
  BEGIN
      IF array1 IS NULL OR array2 IS NULL OR array_length(array1, 1) IS NULL OR array_length(array2, 1) IS NULL OR (array_length(array1, 1) = 0 AND array_length(array2, 1) = 0) THEN
          RETURN 0.0;
      END IF;

      -- Calculate intersection
      SELECT count(*) INTO intersection_count
      FROM (
          SELECT unnest(array1) INTERSECT SELECT unnest(array2)
      ) AS intersect_elements;

      -- Calculate union
      SELECT count(*) INTO union_count
      FROM (
          SELECT unnest(array1)
          UNION -- UNION implicitly takes distinct elements
          SELECT unnest(array2)
      ) AS union_elements;

      IF union_count = 0 THEN
          RETURN 0.0; -- Should be covered by initial check, but as a safeguard
      END IF;

      RETURN intersection_count::FLOAT / union_count::FLOAT;
  END;
  $$ LANGUAGE plpgsql IMMUTABLE;

  COMMENT ON FUNCTION public.calculate_jaccard_index_text_arrays(TEXT[], TEXT[]) IS 'Calculates the Jaccard Index between two arrays of text elements. Returns a score between 0.0 and 1.0.';
  ```

## Tasks / Subtasks

- [x] Create a migration file to implement the `calculate_jaccard_index_text_arrays` PostgreSQL function
- [x] Implement the function's logic to calculate the Jaccard Index accurately
- [x] Add error handling for edge cases (NULL arrays, empty arrays)
- [x] Add appropriate function comment
- [x] Test the function with various input scenarios to verify its correctness

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:** Test the function with various input cases:
  - Both arrays with common elements
  - Arrays with no common elements
  - One empty array and one non-empty array
  - Both arrays identical
  - Both arrays NULL
  - One array NULL

- **Manual Verification:** 
  - Execute SQL queries to test the function with different array inputs
  - Verify that the function returns the expected output for each test case
  - Especially verify edge cases are handled correctly

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** GPT-4.1
- **Completion Notes:**
  - The function was created and deployed via migration.
  - All test cases (common elements, no common elements, identical arrays, empty arrays, NULLs) returned expected results:
    - Overlap: 0.5
    - No overlap: 0.0
    - Identical: 1.0
    - Any NULL/empty: 0.0
  - Function is robust for all required edge cases.
- **Change Log:**
  - Initial Draft
  - Migration and function implemented, tested, and story completed. 