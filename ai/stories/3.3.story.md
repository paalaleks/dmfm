# Story 3.3: Implement Player Controls (Next/Previous Track, Volume, Shuffle)

**Status:** Done

## Goal & Context

**User Story:** As a user, I want to be able to skip to the next or previous track, adjust the volume, and toggle shuffle mode, so that I have more comprehensive control over my music listening experience within the application.

**Context:** This story enhances the basic player UI created in Story 3.2 (`Implement Basic Player UI`). It builds upon the `MusicContext` (Story 3.1) by adding functionalities for track navigation (FR10), volume control, and shuffle control (completing FR8). These controls are essential for a standard music player experience.

## Detailed Requirements

*   **Next Track Control:**
    *   Implement a "Next Track" button in the `Player` component.
    *   Clicking the button should trigger the `player.nextTrack()` method from the Spotify Web Playback SDK via the `MusicContext`.
*   **Previous Track Control:**
    *   Implement a "Previous Track" button in the `Player` component.
    *   Clicking the button should trigger the `player.previousTrack()` method from the Spotify Web Playback SDK via the `MusicContext`.
*   **Volume Control:**
    *   Implement a volume slider in the `Player` component.
    *   The slider should reflect the current volume from `playbackState.device.volume_percent`.
    *   Changing the slider should call `player.setVolume()` via the `MusicContext` (SDK volume is 0.0 to 1.0).
    *   Implement a "Mute/Unmute" button.
        *   Toggles volume between 0 and the last known volume.
        *   Icon should change to reflect mute status.
*   **Shuffle Control:**
    *   Implement a "Shuffle" toggle button in the `Player` component.
    *   The button\'s state (active/inactive) should reflect `playbackState.shuffle`.
    *   Toggling the button should change the shuffle state for the current playback via the Spotify Web API (`PUT /v1/me/player/shuffle`). This will require a new method in `MusicContext` that uses the user\'s access token.

## Acceptance Criteria (ACs)

- AC1: The `MusicContext` (`context/music-context.tsx`) is updated to include methods for `nextTrack()`, `previousTrack()`, `setVolume(volume: number)`, and `toggleShuffle()`.
- AC2: The `Player` component (`components/player/player.tsx`) renders a "Next Track" button that, when clicked, successfully calls the `nextTrack` method in `MusicContext` and skips to the next song.
- AC3: The `Player` component renders a "Previous Track" button that, when clicked, successfully calls the `previousTrack` method in `MusicContext` and goes to the previous song.
- AC4: The `Player` component displays a volume slider (e.g., using Shadcn `Slider`) that reflects the current player volume and allows setting the volume by calling `setVolume` in `MusicContext`.
- AC5: The `Player` component displays a Mute/Unmute button that correctly mutes (sets volume to 0) and unmutes (restores previous volume), updating its icon accordingly.
- AC6: The `Player` component displays a Shuffle button whose visual state (active/inactive) reflects `playbackState.shuffle`.
- AC7: Clicking the Shuffle button successfully calls the `toggleShuffle` method in `MusicContext`, and the shuffle state is updated on Spotify (verified by `playbackState` update or Spotify app).
- AC8: All new player controls are disabled if the player is not ready (`isReady` is false) or if there is no active device/player instance.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`.

- **Relevant Files:**
  - Files to Modify: `context/music-context.tsx`, `components/player/player.tsx`
  - _(Hint: See `docs/project-structure.md` for overall layout)_

- **Key Technologies:**
  - React (Context API, Hooks)
  - Next.js (Client Components)
  - TypeScript
  - Spotify Web Playback SDK (instance from `MusicContext`):
    - `player.nextTrack()`
    - `player.previousTrack()`
    - `player.setVolume(volume: number)` (volume is 0.0 to 1.0)
    - `player.getCurrentState()` (to get current volume if needed for unmute logic)
  - Spotify Web API (for shuffle, via user access token):
    - Endpoint: `PUT /v1/me/player/shuffle?state={boolean}&device_id={string}`
    - This may require using an instance of `@spotify/web-api-ts-sdk` initialized with the user\'s token, or a new Server Action. The context should abstract this.
  - Shadcn UI / Tailwind CSS:
    - `Button` for next, previous, mute, shuffle.
    - `Slider` for volume control.
    - Icons from `lucide-react` (e.g., `SkipForward`, `SkipBack`, `Volume2`, `VolumeX`, `Shuffle`).
  - _(Hint: See `docs/tech-stack.md` for full list and `lib/spotify-api.ts` for existing server-side Spotify API client, noting it uses client_credentials, not user tokens.)_

- **API Interactions / SDK Usage:**
  - **Playback SDK (in `MusicContext` / `Player`):**
    - `player.nextTrack().catch(handleError);`
    - `player.previousTrack().catch(handleError);`
    - `player.setVolume(newVolume).catch(handleError);` (convert percentage from slider to 0.0-1.0)
  - **Web API for Shuffle (in `MusicContext`):**
    - The `toggleShuffle` method in `MusicContext` will need to:
      1. Get the current user\'s Spotify access token (already available in `MusicContext`).
      2. Get the current `deviceId`.
      3. Get the desired new shuffle state (opposite of `playbackState.shuffle`).
      4. Make a `PUT` request to `https://api.spotify.com/v1/me/player/shuffle?state=<newState>&device_id=<deviceId>` with `Authorization: Bearer <accessToken>`.
      5. Handle response and errors. This logic should be encapsulated within `MusicContext`.
    - Consider creating a helper in `lib/spotify-api.ts` or a new client-side utility if `@spotify/web-api-ts-sdk` is not already set up for client-side user-authenticated calls. For simplicity, a direct `fetch` call within the context method, using the token from `tokenRef.current`, is also an option.

- **UI/UX Notes:**
  - Arrange controls logically within the existing `Player` (e.g., Prev/Play/Next together, Volume and Shuffle nearby).
  - Volume slider should provide good user feedback.
  - Mute button should clearly indicate muted state (e.g., `VolumeX` icon) vs. unmuted (`Volume1`, `Volume2` icons based on level).
  - Shuffle button should clearly indicate active state (e.g., different color or icon style).
  - Tooltips (Shadcn `Tooltip`) for icon buttons are recommended for better UX.

- **Data Structures:**
  - Extend `MusicContextState` in `context/music-context.tsx` with the new control methods.
  - Store last active volume in `MusicProvider` state to restore after unmuting.

- **Environment Variables:** None new for this story.

- **Coding Standards Notes:**
  - Ensure all SDK calls and API calls have `.catch()` error handling.
  - New functions in `MusicContext` should be `useCallback` wrapped if they are passed down or have dependencies.
  - Button `disabled` states should be managed based on `isReady`, `player`, and `deviceId` from `MusicContext`.

## Tasks / Subtasks

- [x] **Task 1: Extend `MusicContext`**
  - [x] Define and implement `nextTrack()` method in `MusicContext` to call `player.nextTrack()`.
  - [x] Define and implement `previousTrack()` method in `MusicContext` to call `player.previousTrack()`.
  - [x] Define and implement `setVolume(volume: number)` method in `MusicContext` to call `player.setVolume()`.
  - [x] Add state to `MusicProvider` to store pre-mute volume.
  - [x] Define and implement `toggleMute()` method in `MusicContext` (sets volume to 0 or restores pre-mute volume).
  - [x] Define and implement `toggleShuffle()` method in `MusicContext` to make the Web API call to Spotify.
  - [x] Expose these new methods in the `MusicContextState` and `contextValue`.

- [x] **Task 2: Implement Next/Previous Track Buttons in `Player`**
  - [x] Add "Previous Track" `Button` with `SkipBack` icon.
  - [x] Connect its `onClick` to `musicContext.previousTrack()`.
  - [x] Add "Next Track" `Button` with `SkipForward` icon.
  - [x] Connect its `onClick` to `musicContext.nextTrack()`.
  - [x] Ensure buttons are appropriately disabled based on context state.

- [x] **Task 3: Implement Volume Controls in `Player`**
  - [x] Add a Shadcn `Slider` component for volume.
    - [x] Its value should be derived from `musicContext.currentVolumePercent`.
    - [x] Its `onValueChange` (or similar) should call `musicContext.setVolume()` (adapting percentage to 0.0-1.0 scale).
  - [x] Add a "Mute/Unmute" `Button`.
    - [x] Icon should change (e.g., `Volume2` to `VolumeX`).
    - [x] `onClick` should call `musicContext.toggleMute()`.
  - [x] Ensure controls are appropriately disabled.

- [x] **Task 4: Implement Shuffle Toggle Button in `Player`**
  - [x] Add a "Shuffle" `Button` with `Shuffle` icon.
  - [x] Its visual state (e.g., color, variant) should reflect `playbackState.shuffle`.
  - [x] `onClick` should call `musicContext.toggleShuffle()`.
  - [x] Ensure button is appropriately disabled.

- [ ] **Task 5: Refine Layout and Add Tooltips** (Skipped as per user request)
  - [ ] Arrange new controls within `Player` for good usability. (Skipped)
  - [ ] Add `Tooltip` components to all icon-based buttons. (Skipped)

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:** (Future)
    - For `MusicContext`: Mock Spotify Player and API calls to test that context methods call the correct underlying functions.
- **Manual/CLI Verification:**
    - Log into the application with Spotify. Play a track from Spotify (e.g., desktop app) to activate the player.
    - **Next/Previous:**
        - Verify "Next Track" and "Previous Track" buttons are visible and enabled.
        - Click "Next Track", verify music changes to the next song in the current context (e.g. playlist).
        - Click "Previous Track", verify music changes to the previous song.
        - Verify behavior at the beginning/end of a playlist.
    - **Volume:**
        - Verify volume slider and mute button are visible and enabled.
        - Observe that slider reflects current Spotify volume.
        - Change volume with slider, verify volume changes in Spotify.
        - Click Mute button, verify volume goes to 0 and icon changes.
        - Click Unmute button, verify volume restores to previous level and icon changes.
    - **Shuffle:**
        - Verify shuffle button is visible and enabled.
        - Observe button state reflects current shuffle state from Spotify.
        - Click Shuffle button, verify shuffle state changes in Spotify (check `playbackState` or Spotify app) and button updates. Toggle again to confirm.
    - **Disabled States:** Verify all new controls are disabled if `isReady` is false, or no `player` / `deviceId`.
    - Check browser console for any errors during operations.

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:**
  - Initial Draft 