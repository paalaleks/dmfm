# Story: Implement Random Start Position for Shuffled Auto-Play

**Epic:** 12
**Story ID:** 12.1
**Title:** Implement Random Start Position for Shuffled Auto-Play
**Assigned to:**
**Reporter:** ArchitectAgent
**Status:** Approved
**Points:** (Estimate after implementation discussion)

## User Story

As a user, when I have shuffle mode enabled and the player auto-plays a playlist on mount, I want the playback to start from a random track in the playlist, so that I don't always hear the first song of the playlist initially.

## Background

Currently, when the application auto-plays a playlist with shuffle enabled upon mounting, it always starts from the first track. This story aims to change this behavior to start from a random track within the selected playlist.

The primary challenge identified (see `ai/random-position.md` for full history) is that the `Playlist` object used during the auto-play effect (`Auto-Play First Playlist Effect` in `music-context.tsx`) does not reliably contain the `tracks.total` count when playing playlists directly from Spotify that haven't been pre-enriched with this data from our database.

## Technical Implementation Plan

1.  **Create `fetchPlaylistTotalTracksAPI` Utility Function:**
    *   **File:** `music-context/spotify-api.ts`
    *   **Purpose:** To fetch only the total number of tracks for a given playlist directly from the Spotify API.
    *   **Function Signature (example):**
        ```typescript
        async function fetchPlaylistTotalTracksAPI(
          playlistId: string,
          token: string
        ): Promise<number | null>
        ```
    *   **Logic:**
        *   Make a `GET` request to the Spotify API: `https://api.spotify.com/v1/playlists/{playlist_id}?fields=tracks.total`.
        *   Use the provided `token` for authorization.
        *   Parse the response to extract `tracks.total`.
        *   Return the total count as a number.
        *   Handle potential errors (e.g., API errors, network issues, playlist not found) gracefully by returning `null` or throwing a catchable error.
    *   **Type Hinting:** Use appropriate TypeScript types for request and response, potentially leveraging or adapting `SpotifyPlaylist` from `types/spotify.ts` for the response structure if it fits.

2.  **Modify `Auto-Play First Playlist Effect`:**
    *   **File:** `music-context.tsx`
    *   **Locate:** The `useEffect` hook responsible for auto-playing the first playlist on mount.
    *   **Logic Update:**
        *   Maintain existing conditions for auto-play (e.g., `autoPlayOnMount`, `currentPlaylistId`, `isReady`, `playbackState` initialized).
        *   If `playbackState.shuffle` is `true`:
            *   Asynchronously call the newly created `fetchPlaylistTotalTracksAPI` using `currentPlaylistId` (or `playlistToPlay.id`) and the Spotify access token.
            *   **Await** the result.
            *   If `totalTracks` is successfully fetched from the API and `totalTracks > 0`:
                *   Calculate `startIndex = Math.floor(Math.random() * totalTracks)`.
            *   Else (API call fails, returns `null`, or `totalTracks` is 0):
                *   Default `startIndex = 0` (failsafe to start from the beginning).
                *   Log a warning about failing to fetch total tracks for randomization.
        *   Else (if `playbackState.shuffle` is `false`):
            *   Set `startIndex = 0`.
        *   Proceed to call `playPlaylist(playlistToPlay, startIndex)` with the determined `playlistToPlay` object and the calculated `startIndex`.

## Acceptance Criteria

1.  When the application loads and auto-play is triggered for a playlist:
    *   If `playbackState.shuffle` is `true`, playback begins from a randomly selected track within that playlist.
    *   If `playbackState.shuffle` is `false`, playback begins from the first track (index 0).
2.  The `fetchPlaylistTotalTracksAPI` function in `music-context/spotify-api.ts` correctly calls the specified Spotify API endpoint (`v1/playlists/{playlist_id}?fields=tracks.total`).
3.  `fetchPlaylistTotalTracksAPI` correctly extracts and returns the `tracks.total` value if the API call is successful.
4.  `fetchPlaylistTotalTracksAPI` handles API errors (e.g., invalid playlist ID, token issues, network errors) by returning `null` or allowing the calling function to catch errors, preventing application crashes.
5.  In `music-context.tsx`, if fetching `totalTracks` fails while shuffle is on, the `startIndex` defaults to `0`, and a console warning is logged.
6.  The randomization logic (`Math.random()`) is correctly applied to produce a valid `startIndex` within the range `[0, totalTracks - 1]`.
7.  No new linter errors are introduced.
8.  The feature is verified by observing playback behavior and console logs indicating the `startIndex` used.

## Out of Scope

*   Changing the shuffle behavior *after* the initial track has started playing.
*   Fetching full track details for all tracks in the `fetchPlaylistTotalTracksAPI` call (it should remain minimal to `tracks.total` for efficiency).
*   Persisting the random start index if the component re-mounts without a full page reload (current behavior is to re-evaluate on mount).

## Dependencies

*   Availability of a valid Spotify access token within `music-context.tsx`.
*   The existing `playPlaylist` function in `MusicContext` correctly handles the `startIndex` parameter.
*   The Spotify API endpoint `v1/playlists/{playlist_id}` must be accessible.

## Notes & Questions

*   Ensure the Spotify access token is correctly retrieved and passed to `fetchPlaylistTotalTracksAPI`.
*   Consider the user experience if the API call to fetch `totalTracks` introduces a noticeable delay. For now, we'll proceed with the assumption that this lightweight call is acceptable. 