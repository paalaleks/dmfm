## Story 12.1: Implement Core Custom Shuffle Logic and API Integration

**Status:** Done

**Epic:** Epic 12 - Enhanced Playlist Shuffling

**Goal:** To implement the foundational backend logic for fetching all playable tracks from a Spotify playlist (including relinking), shuffling them, and initiating playback of this custom queue via the Spotify API.

**Context:** This is the first technical implementation story for Epic 12. It focuses on creating the necessary functions within the `spotify-api.ts` module and ensuring they can be called from `MusicContext.tsx`. This story will not include UI changes for activating the shuffle; that will be handled in a subsequent story. The relinking logic previously explored in Story 3.6 is a key component here for determining track playability.

**Detailed Requirements:**

*   **DR12.1.1 (Corresponds to FR12.1, FR12.2):** Implement a new function in `music-context/spotify-api.ts` named `fetchAllPlayablePlaylistTracksAPI` that:
    *   Accepts a Spotify `token` and `playlistId` as input.
    *   Makes paginated calls to the Spotify API endpoint `GET /v1/playlists/{playlist_id}/tracks` to retrieve all track items in the playlist.
    *   For each track item, it must:
        *   Check if the `track` object is null (can happen for deleted/corrupted playlist entries) or if `track.type !== 'track'`. Such items should be skipped.
        *   Check the `track.is_playable` status.
        *   If `track.is_playable` is `false` or the track is restricted in the user's market (Spotify might indicate this via `track.restrictions` or implicitly by `is_playable: false` when `market=from_token` is used), check if `track.linked_from.id` exists.
        *   If `track.linked_from.id` exists, fetch the full track details for this linked track ID using `GET /v1/tracks/{linked_from_id}?market=from_token`.
        *   The relinked track should then be used if *it* is playable.
        *   Filter out any tracks that are local (`track.is_local === true`) as they cannot be played via URI queueing.
    *   Returns a promise that resolves to an array of `SpotifyApiTrackFull` objects representing the playable tracks (using the relinked version where applicable).
    *   Handle API errors gracefully.

*   **DR12.1.2 (Corresponds to FR12.3):** Implement a generic array shuffling function (e.g., `shuffleArray<T>(array: T[]): T[]`) within `music-context/spotify-api.ts` or a shared utility file. This function should implement the Fisher-Yates shuffle algorithm or use a well-tested library equivalent.

*   **DR12.1.3 (Corresponds to FR12.4, FR12.5):** Implement a new function in `music-context/spotify-api.ts` named `playPlaylistWithCustomShuffleAPI` that:
    *   Accepts `token`, `deviceId`, and `playlistId`.
    *   Calls `fetchAllPlayablePlaylistTracksAPI` to get the list of playable tracks.
    *   If no playable tracks are found, it should throw an error or return a status indicating this.
    *   Extracts the URIs from the playable tracks (`track.uri`).
    *   Calls `shuffleArray` to shuffle these URIs.
    *   Calls the existing `toggleShuffleAPI(token, deviceId, false)` to ensure Spotify's native shuffle is disabled.
    *   Makes a `PUT` call to `makeSpotifyApiCall` for the endpoint `/me/player/play?device_id={deviceId}` with a body containing `{ "uris": shuffledTrackUris }`.
    *   Handles API errors gracefully.

*   **DR12.1.4:** Modify `music-context/music-context.tsx` to:
    *   Add a new method to the `MusicContextState` and its implementation, e.g., `playPlaylistWithCustomShuffle(playlist: Playlist, trackIndex?: number): Promise<void>`. (The `trackIndex` might be ignored for this shuffle type as we are shuffling the whole playlist, but including it for consistency or future variations might be considered. For now, it's optional and the shuffle will start from the beginning of the shuffled list).
    *   This new method will internally call `playPlaylistWithCustomShuffleAPI` using the current token, device ID, and the `playlist.spotify_id`.
    *   It should handle errors from the API call, potentially setting an error state in the context and showing a toast notification.
    *   Update the `currentPlaylistIndex` and `currentPlaylistName` similar to how `playPlaylist` does.

**Acceptance Criteria (ACs):**

*   **AC1:** Calling `fetchAllPlayablePlaylistTracksAPI` with a valid playlist ID returns an array of `SpotifyApiTrackFull` objects, correctly handling pagination and relinking unplayable tracks to their playable counterparts if available. Local tracks are excluded.
*   **AC2:** The `shuffleArray` function correctly implements a random shuffle (e.g., Fisher-Yates).
*   **AC3:** Calling `playPlaylistWithCustomShuffleAPI` for a playlist results in:
    *   Spotify's native shuffle being turned OFF via `toggleShuffleAPI`.
    *   A `PUT` request to `/me/player/play` with a body containing a randomly shuffled list of playable track URIs from that playlist.
*   **AC4:** The `playPlaylistWithCustomShuffle` method in `MusicContext` successfully invokes `playPlaylistWithCustomShuffleAPI` and updates relevant context state (e.g., `currentPlaylistName`).
*   **AC5:** If `fetchAllPlayablePlaylistTracksAPI` returns an empty list of playable tracks (e.g., playlist was empty or all tracks were unplayable/local), `playPlaylistWithCustomShuffleAPI` and subsequently the context method handle this gracefully (e.g., by not attempting to play and showing an error/toast).
*   **AC6:** All new functions in `spotify-api.ts` include error handling for API calls and unexpected responses.

**Technical Implementation Context:**

*   **Files to Modify:**
    *   `music-context/spotify-api.ts`: For all new API interaction functions and shuffle logic.
    *   `music-context/music-context.tsx`: To add the new playback method to the context.
    *   `types/spotify.ts` or `types/music-context.ts`: If any new type definitions are needed (though `SpotifyApiTrackFull` should cover most track object needs).
*   **Potentially New Files:**
    *   A utility file (e.g., `utils/array-utils.ts`) if `shuffleArray` is decided to be placed there for broader use.
*   **Key Technologies:**
    *   Spotify Web API (for fetching playlist tracks, track details, playing tracks).
    *   TypeScript.
*   **API Interactions:**
    *   `GET /v1/playlists/{playlist_id}/tracks` (with `limit`, `offset`, `market=from_token`, and `fields` to optimize response size, e.g., `fields=items(track(id,uri,name,type,is_playable,is_local,linked_from(id),restrictions,available_markets)),next,total`).
    *   `GET /v1/tracks/{id}` (with `market=from_token` for fetching relinked track details).
    *   `PUT /v1/me/player/shuffle?state=false&device_id={device_id}`
    *   `PUT /v1/me/player/play?device_id={device_id}` (with `uris` array in JSON body).
*   **Data Structures:**
    *   `SpotifyApiTrackFull` from `../types/spotify`.
*   **Error Handling:** Robust error handling for all API calls, including network errors, rate limits, and specific Spotify API errors (e.g., 401, 403, 404). Errors should be propagated or handled to provide user feedback via `MusicContext`.

**UI/UX Notes:**
*   No direct UI changes in this story. Activation will be manual (e.g., via developer console or temporary trigger) for testing the backend logic.

**Tasks / Subtasks:**

*   **[X] Design & Planning:**
    *   [X] Finalize the exact `fields` parameter for `GET /v1/playlists/{playlist_id}/tracks` to ensure all necessary track data (including `linked_from`, `is_playable`, `is_local`, `uri`, `type`, `restrictions`, `available_markets`) is fetched efficiently.
    *   [X] Define error propagation strategy from `spotify-api.ts` functions to `MusicContext.tsx`.
*   **[X] Implementation (`music-context/spotify-api.ts`):**
    *   [X] Implement `fetchAllPlayablePlaylistTracksAPI` including pagination, track filtering, and relinking logic.
    *   [X] Implement `shuffleArray` utility function.
    *   [X] Implement `playPlaylistWithCustomShuffleAPI`.
*   **[X] Implementation (`music-context/music-context.tsx`):**
    *   [X] Add `playPlaylistWithCustomShuffle` method to the context state and provider.
    *   [X] Ensure `currentPlaylistIndex` and `currentPlaylistName` are updated.
    *   [X] Handle errors and provide feedback (e.g., toast notifications for errors like "No playable tracks found").
*   **[-] Testing (Skipped by user request):**
    *   [-] Write unit tests for `shuffleArray`. (Skipped by user request)
    *   [-] Write unit/integration tests for `fetchAllPlayablePlaylistTracksAPI` (mocking Spotify API responses for various scenarios: pagination, no relink needed, relink needed and successful, relink needed and failed, local tracks, empty playlist). (Skipped by user request)
    *   [-] Write integration tests for `playPlaylistWithCustomShuffleAPI` (mocking dependencies). (Skipped by user request)
    *   [-] Manually test the `playPlaylistWithCustomShuffle` method from `MusicContext` using developer tools with various playlists (short, long, containing unplayable/relinkable tracks if possible). (Skipped by user request) 