# Story 7.1: Enhance Spotify Token Management for Resilience

**Status:** Approved

## Goal & Context

**User Story:** As a developer, I want the application's Spotify token fetching mechanism (`getSpotifyAccessToken` or equivalent) to reliably refresh expired tokens and clearly communicate its success or failure, so that the Spotify player remains functional even after tokens expire and the system can react appropriately to token issues.

**Context:** This story is the first step in Epic 7, "Robust Spotify SDK Integration and Error Handling." It directly addresses a core part of the authentication failures noted in the epic's background, specifically ensuring that the application can handle Spotify access token expiration and renewal. This is foundational for subsequent stories that deal with SDK error handling and proactive connection checks. The existing token acquisition logic, likely within `useSpotifySDK.ts` (or a similar Spotify service module) and its interactions with a server-side action like `getSpotifyAccessToken`, needs to be made more robust.

## Detailed Requirements

Ensure the application's Spotify token fetching mechanism (`getSpotifyAccessToken` or equivalent) can reliably refresh expired tokens and clearly communicate its success or failure.

## Acceptance Criteria (ACs)

- AC1: The token management function (e.g., a server-side action like `getSpotifyAccessToken`) attempts to refresh an expired Spotify access token using the refresh token.
- AC2: Upon successful refresh, a new, valid access token (and potentially a new refresh token, if provided by Spotify) is securely handled and the new access token is provided to the client-side SDK.
- AC3: If token fetch or refresh fails (e.g., invalid refresh token, Spotify API error), a clear error status or null access token is returned by the server-side action.
- AC4: The Spotify SDK's `getOAuthToken` callback (within `useSpotifySDK.ts` or equivalent) correctly utilizes the new access token or handles the failure state propagated from the server-side token management function, potentially triggering an `authentication_error` if a token cannot be provided.
- AC5: Sensitive token data (especially refresh tokens) is handled securely and not unnecessarily exposed to the client-side beyond the access token needed for the SDK.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**
  - Files to Modify:
    - The server-side action responsible for fetching/refreshing Spotify tokens (e.g., `lib/actions/spotify.actions.ts` containing `getSpotifyAccessToken`).
    - The client-side Spotify SDK integration hook (e.g., `hooks/useSpotifySDK.ts`), specifically its `getOAuthToken` callback and how it interacts with the server-side action.
    - Potentially session/storage mechanisms if refresh tokens are stored and managed server-side tied to a user session.

- **Key Technologies:**
  - Next.js (Server Actions)
  - TypeScript
  - Spotify Web API (for token refresh endpoint) - likely using `fetch` or a lightweight HTTP client on the server, or methods from `@spotify/web-api-ts-sdk` if it supports server-side auth flows.
  - Supabase (if user sessions are involved in storing refresh tokens securely, though Spotify tokens might be managed independently of the main Supabase user session if they are short-lived or handled via encrypted cookies/server-side storage).

- **API Interactions / SDK Usage:**
  - **Spotify Token Refresh:**
    - HTTP POST request to Spotify's token endpoint (`https://accounts.spotify.com/api/token`).
    - `grant_type` = `refresh_token`
    - `refresh_token` = the user's current Spotify refresh token.
    - `Authorization` header: Basic auth with `SPOTIFY_CLIENT_ID` and `SPOTIFY_CLIENT_SECRET`.
    - Reference: [Spotify Authorization Guide - Refreshing Access Tokens](https://developer.spotify.com/documentation/web-api/tutorials/refreshing-access-tokens)
  - The `useSpotifySDK.ts` hook's `getOAuthToken` function will call the server-side action.

- **Data Structures:**
  - Server-side action return type should clearly indicate success (with new access token) or failure (with error details). Example:
    ```typescript
    export type SpotifyTokenResult =
      | { accessToken: string; error?: null; newRefreshToken?: string /* if applicable */ }
      | { accessToken: null; error: string };
    ```

- **Environment Variables:**
  - `SPOTIFY_CLIENT_ID` (Server-side, for Spotify token refresh API call)
  - `SPOTIFY_CLIENT_SECRET` (Server-side, for Spotify token refresh API call)
  - These are typically configured in Supabase Auth provider settings but will be directly needed by the server-side action performing the refresh. See `docs/environment-variables.md`. Ensure these are accessed securely on the server.

- **Coding Standards Notes:**
  - Follow standards in `docs/coding-standards.md`.
  - Ensure secure handling of `SPOTIFY_CLIENT_SECRET` and refresh tokens on the server. Do not expose them to the client.
  - All `async/await` operations must have robust error handling.

## Tasks / Subtasks

- [ ] **Server-Side (`getSpotifyAccessToken` or equivalent action):**
  - [ ] Modify the action to accept an optional parameter indicating a refresh is needed or to intelligently detect if the current access token (if stored server-side and tracked for expiry) is likely expired.
  - [ ] If a refresh token is available for the user (needs secure storage mechanism, e.g., encrypted HTTP-only cookie, or associated with user's server session if Supabase is used for primary auth and Spotify linked), implement the token refresh call to `https://accounts.spotify.com/api/token`.
  - [ ] Securely update the stored refresh token if Spotify issues a new one.
  - [ ] Return the new access token on success.
  - [ ] Return a structured error response on failure (e.g., invalid refresh token, API error).
  - [ ] Ensure `SPOTIFY_CLIENT_ID` and `SPOTIFY_CLIENT_SECRET` are used correctly and securely from environment variables for the API call.
- [ ] **Client-Side (`useSpotifySDK.ts` or equivalent):**
  - [ ] Ensure the `getOAuthToken` callback correctly calls the server-side action.
  - [ ] If the server-side action indicates success, provide the new access token to the Spotify SDK's callback (`cb(accessToken)`).
  - [ ] If the server-side action indicates failure, handle this appropriately:
    - Log the error.
    - Avoid calling `cb('')` with an empty string if it causes immediate SDK errors; instead, let the SDK potentially trigger its own `authentication_error` by not receiving a token, or explicitly set an internal error state in the hook.
- [ ] **Security Considerations:**
  - [ ] Review and ensure secure storage and handling of Spotify refresh tokens (server-side). They should not be exposed to the client. HTTP-only, secure, SameSite cookies are a common method if not tying directly to a server-side session database.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests (Server-Side Action):**
  - Mock Spotify token refresh API calls.
  - Test successful token refresh scenario.
  - Test Spotify API error during refresh.
  - Test invalid refresh token scenario.
  - Test secure handling of client ID/secret.
- **Integration Tests (Client-Hook <> Server Action):**
  - Test the `getOAuthToken` callback successfully obtains a new token via the action when a refresh is simulated.
  - Test the callback's behavior when the action returns an error (e.g., token refresh failure).
- **Manual/CLI Verification:**
  - Manually expire an access token (e.g., by waiting or if Spotify allows very short-lived tokens for testing).
  - Observe if the application automatically refreshes the token and the player continues to function or becomes ready.
  - Check server logs for correct refresh flow and error logging.
  - Check browser developer tools to ensure refresh tokens are not exposed client-side.

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:**
  - Initial Draft 