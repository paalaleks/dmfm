# Story 2.2: Fetch and Store User Top Artists/Tracks from Spotify

**Status:** Done

## Goal & Context

**User Story:** As a user, I want the application to fetch my top artists and tracks from Spotify upon login or on demand, so that this data can be used to personalize my experience and match me with others based on music taste.

**Context:** This story builds upon the database schema created in Story 2.1 (tables `user_top_artists`, `user_top_tracks`). It implements the functionality described in FR20 (fetch top artists/tracks) by interacting with the Spotify Web API and storing the results in the database.

## Detailed Requirements

1.  Create a Next.js Server Action (e.g., `fetchAndStoreUserTopItems`) that performs the following:
    *   Authenticates the request using the user's session.
    *   Initializes the Spotify Web API SDK (`@spotify/web-api-ts-sdk`) using the user's access token (obtained securely via Supabase Auth session).
    *   Calls the Spotify API endpoint to get the user's top artists (e.g., `spotify.currentUser.topItems('artists', 'medium_term', 50)`).
    *   Calls the Spotify API endpoint to get the user's top tracks (e.g., `spotify.currentUser.topItems('tracks', 'medium_term', 50)`).
    *   Processes the data returned from Spotify to match the structure required by the `user_top_artists` and `user_top_tracks` tables.
    *   Uses the Supabase client (server-side) to perform an `upsert` operation into `user_top_artists` and `user_top_tracks`, inserting new items or updating existing ones based on the composite primary key (`user_id`, `artist_spotify_id` or `track_spotify_id`).
    *   Handles potential errors during API calls or database operations gracefully, returning a structured `ActionResult` (success/failure, message).
2.  Consider where/when this action should be triggered. Possibilities (to be decided during implementation or next stories):
    *   Automatically after login/session establishment.
    *   Manually via a button in a user profile section (future UI).
    *   Periodically via a scheduled function (future).
    *   For this story, focus on creating the action itself. The triggering mechanism can be basic initially (e.g., potentially calling it from a server component on the main page load if a user is logged in and data is stale, or leaving it for manual trigger later).

## Acceptance Criteria (ACs)

- AC1: A Next.js Server Action exists that can successfully fetch the current user's top artists from Spotify using the `@spotify/web-api-ts-sdk`.
- AC2: The Server Action can successfully fetch the current user's top tracks from Spotify.
- AC3: The fetched top artists data is correctly processed and upserted into the `public.user_top_artists` table.
- AC4: The fetched top tracks data is correctly processed and upserted into the `public.user_top_tracks` table.
- AC5: The Server Action handles errors from Spotify API calls or Supabase DB operations and returns an appropriate `ActionResult`.
- AC6: The Server Action properly authenticates the user and uses their specific Spotify credentials/token for the API calls.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Follow project standards.

- **Relevant Files:**
  - Files to Create:
    - `lib/actions/spotify-actions.ts` (or `app/_actions/spotify-actions.ts`) - To house the new Server Action(s).
    - Potentially `lib/spotify.ts` might need updates if SDK initialization logic is centralized there.
  - Files to Modify:
    - Potentially a Server Component (e.g., `app/(main)/page.tsx` or `app/(main)/layout.tsx`) if implementing a basic trigger mechanism on load.
    - `types/database.ts` (Used for Supabase interaction types).
    - `types/spotify.ts` (Potentially add types for processed data if needed).

- **Key Technologies:**
  - Next.js Server Actions
  - `@spotify/web-api-ts-sdk`
  - Supabase Client (Server-side, from `lib/supabase/server.ts`)
  - TypeScript

- **API Interactions / SDK Usage:**
  - Spotify SDK: Primarily `spotify.currentUser.topItems('artists', ...)` and `spotify.currentUser.topItems('tracks', ...)`.
    - Need to handle authentication/token passing to the SDK instance.
    - Requires `user-top-read` Spotify scope during authentication.
  - Supabase Client: `supabase.from('user_top_artists').upsert(...)`, `supabase.from('user_top_tracks').upsert(...)`.

- **UI/UX Notes:**
  - No specific UI required for this story, but the action should be callable from server/client components later.

- **Data Structures:**
  - Use types from `types/database.ts` for `user_top_artists` and `user_top_tracks` inserts/upserts.
  - Map data from Spotify API responses (check `@spotify/web-api-ts-sdk` types) to the database table structures.
    - Ensure `artists` JSONB field in `user_top_tracks` is populated correctly (e.g., `[{ spotify_id: artist.id, name: artist.name }, ...]`).

- **Environment Variables:**
  - Relies on Supabase and potentially Spotify client variables being configured for auth flow (as per `docs/environment-variables.md`). No new variables specific to this story.

- **Coding Standards Notes:**
  - Use `async/await`.
  - Implement robust error handling (`try/catch`) for API and DB calls.
  - Follow Server Action conventions (return `ActionResult`).
  - Ensure Spotify SDK is initialized correctly with user credentials server-side.

## Tasks / Subtasks

- [x] Task 1: Create the Server Action file (e.g., `lib/actions/spotify-actions.ts`).
- [x] Task 2: Implement logic within the action to get the authenticated user and their Supabase session/Spotify token.
- [x] Task 3: Implement Spotify SDK initialization within the action using the user's token.
- [x] Task 4: Call `spotify.currentUser.topItems('artists', ...)`.
- [x] Task 5: Process the top artists response data into the format required for `user_top_artists` table.
- [x] Task 6: Implement `supabase.from('user_top_artists').upsert(...)` call with the processed data.
- [x] Task 7: Call `spotify.currentUser.topItems('tracks', ...)`.
- [x] Task 8: Process the top tracks response data into the format required for `user_top_tracks` table (pay attention to `artists` JSONB format).
- [x] Task 9: Implement `supabase.from('user_top_tracks').upsert(...)` call with the processed data.
- [x] Task 10: Implement comprehensive error handling (try/catch blocks) around API and DB calls.
- [x] Task 11: Structure the return value as `ActionResult<{ artistsUpserted: number, tracksUpserted: number } | null>` or similar.
- [ ] Task 12 (Optional Initial Trigger): Explore adding a basic trigger (e.g., call the action from a server component if data is missing/stale) or defer triggering mechanism to later stories.

## Testing Requirements

**Guidance:** Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:**
  - Consider mocking Spotify SDK and Supabase client to test the data transformation logic within the Server Action in isolation.
- **Integration Tests:**
  - Could test the Server Action against a test Supabase instance and potentially mocked Spotify responses (using MSW if necessary).
- **Manual/CLI Verification:**
  - Log in as a user.
  - Manually trigger the Server Action (e.g., temporarily add a button in the UI or call it directly if possible in dev mode).
  - Verify in Supabase Studio that the `user_top_artists` and `user_top_tracks` tables are populated correctly for the logged-in user.
  - Check network console/server logs for errors.

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:**
  - Initial Draft 