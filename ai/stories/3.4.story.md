# Story 3.4: Implement Playlist Navigation (Next/Previous Taste-Matched Playlist)

**Status:** DONE

**Dependency Note:** Implementation relies on Epic 2 providing a mechanism to fetch/determine a list of taste-matched playlists for the current user. This story assumes such a list (or a mock) is available to the `MusicContext`.

## Goal & Context

**User Story:** As a user, I want to be able to easily navigate between different Spotify playlists suggested for me based on my taste, so that I can explore new music relevant to my preferences directly within the player.

**Context:** This story introduces playlist navigation (FR11) into the player UI built in previous stories (3.2, 3.3). It leverages the `MusicContext` (3.1) and requires integration with the taste-matching logic developed in Epic 2. The goal is to allow users to cycle through a list of playlists (e.g., obtained from `user_playlist_interactions` where `interaction_type` is 'matched_by_taste_algorithm') and start playback of the selected playlist.

## Detailed Requirements

*   **Playlist State Management (in `MusicContext`):**
    *   Add state to store the list of currently available taste-matched playlists for the user (e.g., `tasteMatchedPlaylists: Playlist[]`, where `Playlist` contains at least `spotify_id` and `name`).
    *   Add state to track the index of the currently playing playlist within this list (`currentPlaylistIndex: number | null`).
    *   Add state to store the name of the currently playing playlist (`currentPlaylistName: string | null`).
    *   Implement logic to fetch or receive the `tasteMatchedPlaylists` (Dependency on Epic 2 - use a mock list for initial development).
*   **Playlist Playback Initiation (in `MusicContext`):**
    *   Implement a method `playPlaylist(playlist: Playlist, trackIndex?: number)` that:
        *   Uses the Spotify Web API (`PUT /v1/me/player/play?device_id={device_id}`) to start playback of the given playlist context (`spotify:playlist:{playlist.spotify_id}`).
        *   Optionally allows starting from a specific track index using the `offset` parameter.
        *   Updates `currentPlaylistIndex` and `currentPlaylistName` in the context state.
*   **Playlist Navigation Controls (in `player`):**
    *   Implement a "Next Playlist" button.
    *   Implement a "Previous Playlist" button.
    *   Clicking these buttons should call corresponding methods (`nextPlaylist()`, `previousPlaylist()`) in `MusicContext`.
    *   These context methods will calculate the next/previous index in the `tasteMatchedPlaylists` array (handling wrapping) and call `playPlaylist` with the new playlist.
*   **Display Current Playlist Name (in `player`):**
    *   Update the player UI to display the `currentPlaylistName` from the `MusicContext` (related to FR9).

## Acceptance Criteria (ACs)

- AC1: `MusicContext` state is extended to include `tasteMatchedPlaylists` (initially mocked), `currentPlaylistIndex`, and `currentPlaylistName`.
- AC2: `MusicContext` includes a `playPlaylist` method capable of starting playback of a specified playlist context via the Spotify Web API.
- AC3: `MusicContext` includes `nextPlaylist` and `previousPlaylist` methods that correctly cycle through the `tasteMatchedPlaylists` and trigger playback of the selected playlist.
- AC4: The `player` component renders "Next Playlist" and "Previous Playlist" buttons.
- AC5: Clicking the "Previous Playlist" button successfully calls `previousPlaylist` in `MusicContext`, starts playback of the previous playlist in the list, and updates the displayed playlist name.
- AC6: Clicking the "Next Playlist" button successfully calls `nextPlaylist` in `MusicContext`, starts playback of the next playlist in the list, and updates the displayed playlist name.
- AC7: The `player` component displays the name of the currently playing playlist (obtained from `currentPlaylistName` in `MusicContext`).
- AC8: Navigation buttons are appropriately disabled if there are fewer than two playlists in the `tasteMatchedPlaylists` list or if the player is not ready.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Follow project standards.

- **Relevant Files:**
  - Files to Modify:
    - `context/music-context.tsx`
    - `components/player/player.tsx`

## Tasks / Subtasks

- [x] **Task 1: Define Types and Extend Context State**
  - [x] Define `Playlist` interface/type in `types/spotify.ts` or `types/index.ts`.
  - [x] Add `tasteMatchedPlaylists`, `currentPlaylistIndex`, `currentPlaylistName` state variables to `MusicProvider` in `context/music-context.tsx`.
  - [x] Add placeholders for `playPlaylist`, `nextPlaylist`, `previousPlaylist` methods to `MusicContextState` and `initialState`.

- [x] **Task 2: Implement Mock Playlist Loading**
  - [x] Add a `useEffect` in `MusicProvider` to load a hardcoded mock list into `tasteMatchedPlaylists` state for development purposes.

- [x] **Task 3: Implement `playPlaylist` Method**
  - [x] Implement the `playPlaylist` method in `MusicProvider` using `fetch` to call the Spotify `play` endpoint with the correct `context_uri` and optional `offset`.
  - [x] Ensure it updates `currentPlaylistIndex` and `currentPlaylistName` state upon successful initiation.
  - [x] Include error handling.

- [x] **Task 4: Implement `nextPlaylist` and `previousPlaylist` Methods**
  - [x] Implement `nextPlaylist` method: calculate next index (wrapping around), get the playlist from `tasteMatchedPlaylists`, and call `playPlaylist`.
  - [x] Implement `previousPlaylist` method: calculate previous index (wrapping around), get the playlist, and call `playPlaylist`.
  - [x] Handle cases where the playlist list is empty or has only one item.

- [x] **Task 5: Expose New State and Methods**
  - [x] Add the new state variables and methods to the `contextValue` returned by `MusicProvider`.

- [x] **Task 6: Update `PlayerUI` Component**
  - [x] Destructure new state (`currentPlaylistName`, `tasteMatchedPlaylists`) and methods (`nextPlaylist`, `previousPlaylist`) from `useMusic()`.
  - [x] Display `currentPlaylistName` below the track/artist info.
  - [x] Add "Previous Playlist" button (with icon) calling `previousPlaylist`.
  - [x] Add "Next Playlist" button (with icon) calling `nextPlaylist`.
  - [x] Add disabled logic based on `isReady` and the number of playlists available (`tasteMatchedPlaylists.length`).
  - [x] Add Tooltips to the new buttons.

## Testing Requirements